{% extends "partials/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}
    Candidate Task List
{% endblock title %}
{% block extra_css %}
    <!-- Sweet Alert css-->
    <link href="{% static 'libs/sweetalert2/dist/sweetalert2.min.css' %}"
          rel="stylesheet"
          type="text/css"/>
    <link rel="stylesheet"
          href="{% static 'js/DataTables/datatables.min.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="Robots" title="Candidate Task List" %}
                {% endblock pagetitle %}
                {% include "partials/messages.html" %}
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card"  id="tasksList">
                            <div class="card-header border-0">
                                <div class="d-flex align-items-center">
                                    <h5 class="card-title mb-0 flex-grow-1">All Candidate Tasks</h5>
                                    <div class="flex-shrink-0">
                                        {% if perms.robots.add_source %}
                                            <a role="button"
                                               href="{% url 'robots:candidatetask_create' %}"
                                               class="btn btn-danger add-btn">
                                                <i class="ri-add-line align-bottom me-1"></i> Create Candidate Task
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body border border-dashed border-end-0 border-start-0">
                                <form>
                                    <div class="row g-3">
                                        <div class="col-xxl-5 col-sm-12">
                                            <div class="search-box">
                                                <input type="text"
                                                       class="form-control search bg-light border-light"
                                                       placeholder="Search for teams or something...">
                                                <i class="ri-search-line search-icon"></i>
                                            </div>
                                        </div>
                                        <!--end col-->
                                        <div class="col-xxl-1 col-sm-4">
                                            <button type="button" class="btn btn-primary w-100" onclick="SearchData();">
                                                <i class="ri-equalizer-fill me-1 align-bottom"></i>
                                                Filters
                                            </button>
                                        </div>
                                        <!--end col-->
                                    </div>
                                    <!--end row-->
                                </form>
                            </div>
                            <!--end card-body-->
                            <div class="card-body">
                                <div class="table-responsive table-card mb-4">
                                    <table class="table align-middle table-nowrap mb-0" id="tasksTable">
                                        <thead class="table-light text-muted">
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Robot</th>
                                                <th>Job</th>
                                                <th>Template</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="list form-check-all">
                                            {% for row in candidatetask_list %}
                                                <tr>
                                                    <td class="id">{{ row.id }}</td>
                                                    <td class="client_name">{{ row.name }}</td>
                                                    <td class="client_name">{{ row.robot }}</td>
                                                    <td class="client_name">{{ row.job }}</td>
                                                    <td class="client_name">
                                                        {{ row.candidate_template }}
                                                        <a href="javascript:void(0)"
                                                           data-id="{{ row.candidate_template.id }}"
                                                           class="text-primary d-inline-block person-edit-btn candidate-edit-btn"
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#candidateUpdate">
                                                            <i class="ri-pencil-fill fs-16"></i>
                                                        </td>
                                                        <td class="client_name">
                                                            <span class="badge {% if row.status == row.Status.OPEN %} badge-soft-primary {% elif row.status == row.Status.CLOSED %} badge-soft-warning {% else %} badge-soft-success {% endif %} ">
                                                                {{ row.get_status_display }}
                                                            </span>
                                                        </td>
                                                        <td class="due_date">{{ row.created }}</td>
                                                        <td>
                                                            <ul class="list-inline hstack gap-2 mb-0">
                                                                {% if perms.robots.view_candidatetask %}
                                                                    <li class="list-inline-item edit"
                                                                        data-bs-toggle="tooltip"
                                                                        data-bs-trigger="hover"
                                                                        data-bs-placement="top"
                                                                        title="View">
                                                                        <a href="{% url 'robots:candidatetask_details' pk=row.id %}"
                                                                           class="text-primary d-inline-block edit-item-btn">
                                                                            <i class="ri-eye-fill fs-16"></i>
                                                                        </a>
                                                                    </li>
                                                                {% endif %}
                                                                {% if perms.robots.change_candidatetask %}
                                                                    <li class="list-inline-item edit"
                                                                        data-bs-toggle="tooltip"
                                                                        data-bs-trigger="hover"
                                                                        data-bs-placement="top"
                                                                        title="Edit">
                                                                        <a href="{% url 'robots:candidatetask_edit' pk=row.id %}"
                                                                           class="text-primary d-inline-block edit-item-btn">
                                                                            <i class="ri-pencil-fill fs-16"></i>
                                                                        </a>
                                                                    </li>
                                                                {% endif %}
                                                                {% if perms.robots.delete_candidatetask %}
                                                                    <li class="list-inline-item"
                                                                        data-bs-toggle="tooltip"
                                                                        data-bs-trigger="hover"
                                                                        data-bs-placement="top"
                                                                        title="Remove">
                                                                        <a class="delete-btn text-danger d-inline-block remove-item-btn"
                                                                           data-bs-toggle="modal"
                                                                           href="#deleteOrder"
                                                                           data-url="{% url 'robots:candidatetask_delete' pk=row.id %}">
                                                                            <i class="ri-delete-bin-5-fill fs-16"></i>
                                                                        </a>
                                                                    </li>
                                                                {% endif %}
                                                            </ul>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <!--end table-->
                                    </div>
                                    {% include "partials/pagination.html" with is_paginated=is_paginated page_obj=page_obj paginator=paginator %}
                                </div>
                                <!--end card-body-->
                            </div>
                            <!--end card-->
                        </div>
                        <!--end col-->
                    </div>
                    <!--end row-->
                    <div class="modal fade flip"
                         id="deleteOrder"
                         tabindex="-1"
                         aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-body p-5 text-center">
                                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                    <div class="mt-4 text-center">
                                        <h4>You are about to delete ?</h4>
                                        <p class="text-muted fs-14 mb-4">
                                            Deleting your task will remove all of
                                            your information from our database.
                                        </p>
                                        <div class="hstack gap-2 justify-content-center remove">
                                            <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none"
                                                    data-bs-dismiss="modal">
                                                <i class="ri-close-line me-1 align-middle"></i> Close
                                            </button>
                                            <a class="btn btn-danger" id="delete-record">Yes, Delete It</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end delete modal -->
                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
            <!-- Modal FORM for Person Update -->
            <div id="candidateUpdate"
                 class="modal fade"
                 tabindex="-1"
                 aria-labelledby="personUpdateLabel"
                 aria-hidden="true"
                 style="display: none;">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <form action="" id="CandidateUpdateForm" method="post">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="personUpdateLabel">Edit Candidate</h5>
                                <button type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="row">
                                <div class="col-lg-8 offset-lg-2">
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-lg-6">
                                                    <div class="mb-3">{{ form.name|as_crispy_field }}</div>
                                                </div>
                                                <div class="col-lg-6">
                                                    <div class="mb-3">{{ form.subject|as_crispy_field }}</div>
                                                </div>
                                                <div class="col-lg-12">
                                                    <div class="mb-3">{{ form.email_message|as_crispy_field }}</div>
                                                </div>
                                                <div class="col-lg-12">
                                                    <div class="mb-3">{{ form.inmail_message|as_crispy_field }}</div>
                                                </div>
                                                <div class="col-lg-12">
                                                    <div class="mb-3">{{ form.sms_message|as_crispy_field }}</div>
                                                </div>
                                                <div class="col-lg-12">
                                                    <div class="mb-3">{{ form.linkedin_message|as_crispy_field }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- end card body -->
                                    </div>
                                    <!-- end card -->
                                    <div class="text-end mb-4">
                                        <a href="{% url 'robots:candidatetask_list' %}"
                                           class="btn btn-light w-sm close-btn">Cancel</a>
                                        <button type="submit" class="btn btn-success w-sm">
                                            Update
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                                <!-- end col -->
                            </div>
                            <!-- end row -->
                        </form>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
            {% block footer %}
                {% include "partials/footer.html" %}
            {% endblock footer %}
        </div>
        <!-- end main content-->
    {% endblock content %}
    {% block extra_js %}
        <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
        <!--datatable js-->
        <script src="{% static 'js/DataTables/datatables.min.js' %}"></script>
        <script>
    $('tasksTable').DataTable({
        stateSave: true
    });
    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(el => el.addEventListener('click', event => {
        document.getElementById("delete-record").href = event.target.parentElement.getAttribute("data-url")
        
    }));
    
    // Load the candidate for edit mode in modal
    $('.candidate-edit-btn').click(function(){
        let candidateId = $(this).data('id')
        $('#CandidateUpdateForm').data('id', candidateId)
        $.ajax({
            type: "GET",
            url: `/api/candidatetemplate/${candidateId}/`,
            success: function(response){
                let textFields = ['name', 'subject']
                
                let textField = ['email_message', 'inmail_message', 'sms_message','linkedin_message']
                
                textFields.forEach((field)=>{
                    $(`input[name='${field}']`).val(response[field])
                })
                
                textField.forEach((field)=>{
                    if(response[field]){
                        $(`textarea[name='${field}']`).val(response[field])
                    }
                })
                
                
            }
        })
    });
    
    // Bulk Create Candidates from LinkedIn URLs
    $('#CandidateUpdateForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        
        $('.btn-load').removeClass('d-none');
        $('.btn-update-person').addClass('d-none');
        
        var form = $(this);
        let candidatesId = form.data('id')
        $.ajax({
            type: "PUT",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/candidatetemplate/${candidatesId}/`,
            data: form.serialize(), // serializes the form's elements.
            success: function(response)
            {
                $('.btn-load').addClass('d-none');
                $('.btn-update-person').removeClass('d-none');
                $(`.candidate-name[data-id='${candidatesId}']`).text(response.name)
                $(`.candidate-subject[data-id='${candidatesId}']`).text(response.subject)
                $(`.candidate-email[data-id='${candidatesId}']`).text(response.email_message)
                $(`.candidate-inmail_message[data-id='${candidatesId}'] span`).text(response.inmail_message)
                $(`.candidate-sms_message[data-id='${candidatesId}'] span`).text(response.sms_message)
                $(`.candidate-linkedin_message[data-id='${candidatesId}'] span`).text(response.linkedin_message)
                
                $('#candidateUpdate').modal('hide');
                form.trigger("reset");
                $('.close-btn').trigger('click')
            }
        });
    });
    
        </script>
    {% endblock extra_js %}
