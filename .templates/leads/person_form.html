{% extends "partials/base.html" %}
{% load static %}
{% block title %}
    Person
{% endblock title %}
{% block extra_css %}
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% if object %}
                        {% include "partials/page-title.html" with pagetitle="Leads" title="Update Person" %}
                    {% else %}
                        {% include "partials/page-title.html" with pagetitle="Leads" title="Create Person" %}
                    {% endif %}
                {% endblock pagetitle %}
                <form id="personForm" action="" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2">
                            <div class="card">
                                <div class="d-flex flex-row-reverse m-2">
                                    <button type="button" class="btn btn-primary btn-load">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">Loading Data...</span>
                                            <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading Data...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div>
                                                <div id="div_id_company" class="form-group">
                                                    <label for="id_company">Company</label>
                                                    <div>
                                                        <select name="company" class="form-control" id="id_company">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_first_name" class="form-group">
                                                    <label for="id_first_name" class="">First name</label>
                                                    <div>
                                                        <input type="text"
                                                               name="first_name"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_first_name">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_last_name" class="form-group">
                                                    <label for="id_last_name" class="">Last name</label>
                                                    <div>
                                                        <input type="text"
                                                               name="last_name"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_last_name">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_designation" class="form-group">
                                                    <label for="id_designation" class="">Designation</label>
                                                    <div>
                                                        <input type="text"
                                                               name="designation"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_designation">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_linkedin" class="form-group">
                                                    <label for="id_linkedin" class="">Linkedin</label>
                                                    <div>
                                                        <input type="text"
                                                               name="linkedin"
                                                               maxlength="1000"
                                                               class="textinput textInput form-control"
                                                               id="id_linkedin">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_email" class="form-group">
                                                    <label for="id_email" class="">Email</label>
                                                    <div>
                                                        <input type="email"
                                                               name="email"
                                                               maxlength="254"
                                                               class="emailinput form-control"
                                                               id="id_email">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_email2" class="form-group">
                                                    <label for="id_email2" class="">Email2</label>
                                                    <div>
                                                        <input type="email"
                                                               name="email2"
                                                               maxlength="254"
                                                               class="emailinput form-control"
                                                               id="id_email2">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_email3" class="form-group">
                                                    <label for="id_email3" class="">Email3</label>
                                                    <div>
                                                        <input type="email"
                                                               name="email3"
                                                               maxlength="254"
                                                               class="emailinput form-control"
                                                               id="id_email3">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_city" class="form-group">
                                                    <label for="id_city" class="">City</label>
                                                    <div>
                                                        <input type="text"
                                                               name="city"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_city">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_state" class="form-group">
                                                    <label for="id_state" class="">State</label>
                                                    <div>
                                                        <input type="text"
                                                               name="state"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_state">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_country" class="form-group">
                                                    <label for="id_country" class=""requiredField>
                                                        Country<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="country" class="form-control" id="id_country">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_status" class="form-group">
                                                    <label for="id_status" class="" requiredField>
                                                        Status<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="status" class="form-control" id="id_status" required>
                                                            <option value="1" selected>
                                                                New
                                                            </option>
                                                            <option value="2">
                                                                Email Not Found
                                                            </option>
                                                            <option value="3">
                                                                Contacted
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end card body -->
                            </div>
                            <!-- end card -->
                            <div class="text-end mb-4">
                                <a href="{% url 'leads:person_list' %}" class="btn btn-light w-sm">Cancel</a>
                                <button type="submit" class="btn btn-success w-sm">
                                    {% if object %}
                                        Update
                                    {% else %}
                                        Create
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                        <!-- end col -->
                    </div>
                    <!-- end row -->
                </form>
            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
        {% block footer %}
            {% include "partials/footer.html" %}
        {% endblock footer %}
    </div>
    <!-- end main content-->
{% endblock content %}
{% block extra_content %}
{% endblock extra_content %}
{% block extra_js %}
    <!-- project-create init -->
    <script src="{% static 'js/pages/project-create.init.js'%}"></script>
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script>
        $(document).ready(function(){
        const selectField = document.getElementById('id_company');
        {% if object %}            selectField.setAttribute('disabled', 'disabled');{% endif %}
        const companyChoices = new Choices(selectField,{
            shouldSort: false
        });
        const countryChoices = new Choices(document.querySelector('#id_country'),{
            shouldSort: false
        });
        const statusChoices = new Choices(document.querySelector('#id_status'),{
            shouldSort: false
        });
        var progress = 0;
        {% if object %}
        let personId = {{object.id}}
        var requestType = "PATCH"
        var url = `/api/person/${personId}/`
        $.ajax({
            type: "GET",
            url: `/api/person/${personId}`,
            success: function(response){
                let textFields = ['first_name', 'last_name', 'designation', 'email', 'email2', 'email3', 'linkedin', 'city', 'state']
                
                textFields.forEach((field)=>{
                    $(`input[name='${field}']`).val(response[field])
                })
                $.ajax({
                    type: "GET",
                    url: `/api/company/?action=dropdown&search=${response['company']}`,
                    success: function(response){
                        value = response.results[0]
                    },
                    complete: function(){
                        companyChoices.setChoices([{ value: value.id, label: value.name }])
                        companyChoices.setChoiceByValue(value.id);
                        progress +=1;
                        if(progress==2){
                            $('.btn-load').addClass('d-none');
                        }
                        $.ajax({
                            type: "GET",
                            url: '/leads/countrieslist/',
                            data: {},
                            success: function(response){
                                newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                                countryChoices.clearChoices()
                                newChoices.unshift({'value': '', 'label': '---------'})
                                countryChoices.setChoices(newChoices);
                            },
                            complete: function(){
                                    countryChoices.setChoiceByValue(response['country']);
                                    progress +=1;
                                    if(progress==2){
                                        $('.btn-load').addClass('d-none');
                                    }
                                }
                            })
                    }
                })
                    statusChoices.setChoiceByValue(String(response['status']));
            }
        })
        {% else %}
        var url = `/api/person/`
        var requestType = "POST"
            $.ajax({
                type: "GET",
                url: '/api/company/?action=dropdown',
                success: function(response){
                    newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                    companyChoices.clearChoices()
                    newChoices.unshift({'value': '', 'label': '---------'})
                    companyChoices.setChoices(newChoices);
                },
                complete: function(){
                    progress +=1;
                    if(progress==2){
                        $('.btn-load').addClass('d-none');
                    }
                }
            })
        
            $.ajax({
                type: "GET",
                url: '/leads/countrieslist/',
                data: {},
                success: function(response){
                    newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                    countryChoices.clearChoices()
                    newChoices.unshift({'value': '', 'label': '---------'})
                    countryChoices.setChoices(newChoices);
                },
                complete: function(){
                    progress+=1;
                    if(progress==2){
                        $('.btn-load').addClass('d-none');
                    }
                }
            })

    {% endif %}
        
        
        $('#personForm').submit(function(e){
            e.preventDefault(); // avoid to execute the actual submit of the form.
            $('.btn-load').removeClass('d-none');
            $('.btn-create').addClass('d-none');
            var form = $(e.target);
            $.ajax({
                type: requestType,
                headers: { "X-CSRFToken": '{{csrf_token}}' },
                url: url,
                data: form.serialize(), // serializes the form's elements.
                success: (response) => {
                    Toastify({
                        text: "The Person has been added successfully",
                    }).showToast();
                    $('.btn-load').addClass('d-none');
                    $('.btn-create').removeClass('d-none');
                    form.trigger("reset");
                    window.location.href = '/leads/person/list';
                },
                error: (xhr, status, error) => {
                    // Handle Ajax Error for API
                    var err = eval("(" + xhr.responseText + ")");
                    console.error(err)
                    if(Object.keys(err).length){
                        Object.keys(err).forEach((field) => {
                            Toastify({
                                text: `${err[field]} : ${field}`,
                                className: 'bg-danger',
                                style: {
                                  'text-transform': "capitalize",
                                },
                            }).showToast();
                        })
    
                    } else {
                        Toastify({
                          text: "Oops something went wrong.",
                          className: 'bg-danger'
                        }).showToast();
                    }
                    $('.btn-load').addClass('d-none');
                    $('.btn-create').removeClass('d-none');
                }
            });
        })
    })
    </script>
{% endblock extra_js %}
