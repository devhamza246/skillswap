{% extends "partials/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% block title %}
    Lead List
{% endblock title %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{% static 'js/DataTables/datatables.min.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="Leads" title="Lead List" %}
                {% endblock pagetitle %}
                {% include "partials/messages.html" %}
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card"  id="tasksList">
                            <div class="card-header border-0">
                                <div class="d-flex align-items-center gap-3">
                                    <h5 class="card-title mb-0 flex-grow-1">All Leads</h5>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-primary btn-lead-load">
                                            <span class="d-flex align-items-center">
                                                <span class="flex-grow-1 me-2">Loading Data...</span>
                                                <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                    <span class="visually-hidden">Loading Data...</span>
                                                </span>
                                            </span>
                                        </button>
                                    </div>
                                    {% if user.get_role_display == 'Admin' or user.get_role_display == 'Team Lead'%}
                                    <button id="btn_export_csv"
                                                type="button"
                                                class="btn btn-primary">Export CSV
                                    </button>
                                    <button type="button" class="btn btn-primary btn-export-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                    {% endif %}
                                    <div class="btn-group" role="group">
                                        <button id="btnGroupDrop1"
                                                type="button"
                                                class="btn btn-secondary btn-sm dropdown-toggle"
                                                data-bs-toggle="dropdown"
                                                aria-expanded="false">
                                            <i class="ri-user-add-fill align-middle me-1"></i> Add New
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                                            <li>
                                                <a class="dropdown-item csv-bulk"
                                                   href="javascript:void(0)"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#csvLead">CSV Upload</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="flex-shrink-0">
                                        {% if perms.leads.add_lead %}
                                            <a role="button"
                                               href="{% url 'leads:lead_create' %}"
                                               class="btn btn-danger add-btn">
                                                <i class="ri-add-line align-bottom me-1"></i> Create Lead
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body border border-dashed border-end-0 border-start-0">
                                <!-- Filters Form -->
                                <form action="" method="get">
                                    {% include 'leads/partials/lead_filter.html' %}
                                </form>
                                <!-- End Filters Form -->
                            </div>
                            <!--end card-body-->
                            <div class="card-body">
                                <div class="table-responsive table-card mb-4">
                                    <table class="table align-middle table-nowrap mb-0" id="leadsTable">
                                        <thead class="table-light text-muted">
                                            <tr>
                                                <th data-data="id" data-name="id">ID</th>
                                                <th data-data="person.first_name" data-name="person__first_name">First Name</th>
                                                <th data-data="person.last_name" data-name="person__last_name">Last Name</th>
                                                <th data-data="person.email" data-name="person__email">Email</th>
                                                <th data-data="company.name" data-name="company__name">Company</th>
                                                <th data-data="status" data-name="status">Status</th>
                                                <th data-data="created" data-name="created">Created</th>
                                                <th data-data="job_post.city" data-name="job_post__city">City</th>
                                                <th data-data="job_post.state" data-name="job_post__state">State</th>
                                                <th data-data="job_post.country" data-name="job_post__country">Country</th>
                                                <th data-data="job_post.title" data-name="job_post__title">Job Title</th>
                                                <th data-data="person.designation" data-name="person__designation">Designation</th>
                                                <!-- Hidden field addd for Filters -->
                                                <th data-data="person.linkedin" data-name="person__linkedin">LinkedIn</th>
                                                <th data-data="job_post.url" data-name="job_post__url">Job Post URL</th>
                                                <th >Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="list form-check-all">
                                        </tbody>
                                    </table>
                                    <!--end table-->
                                </div>
                            </div>
                            <!--end card-body-->
                        </div>
                        <!--end card-->
                    </div>
                    <!--end col-->
                </div>
                <!--end row-->
                <div class="modal fade flip"
                     id="deleteOrder"
                     tabindex="-1"
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body p-5 text-center">
                                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                <div class="mt-4 text-center">
                                    <h4>You are about to delete ?</h4>
                                    <p class="text-muted fs-14 mb-4">
                                        Deleting your task will remove all of
                                        your information from our database.
                                    </p>
                                    <div class="hstack gap-2 justify-content-center remove">
                                        <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none"
                                                data-bs-dismiss="modal">
                                            <i class="ri-close-line me-1 align-middle"></i> Close
                                        </button>
                                        <a class="btn btn-danger" id="delete-record">Yes, Delete It</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end delete modal -->
                <!-- Modal FORM for Change Status -->
                <div id="changeStatus"
                     class="modal fade"
                     tabindex="-1"
                     aria-labelledby="changeStatusLabel"
                     aria-hidden="true"
                     style="display: none;">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content">
                            <form action="" id="changeStatusForm" data-lead="">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="changeStatusLabel">Change Lead Status</h5>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <select class="form-control"
                                                        data-choices
                                                        data-choices-search-false
                                                        data-choices-sorting-false
                                                        name="change_status">
                                                    <option value="1">
                                                        OPEN
                                                    </option>
                                                    <option value="2">
                                                        CLOSED
                                                    </option>
                                                    <option value="3">
                                                        EMAIL_NOT_FOUND
                                                    </option>
                                                    <option value="4">
                                                        SCHEDULED
                                                    </option>
                                                    <option value="5">
                                                        SENT
                                                    </option>
                                                    <option value="6">
                                                        READY
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">
                                        Update
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- Modal FORM for Person Update -->
                <div id="personUpdate"
                     class="modal fade"
                     tabindex="-1"
                     aria-labelledby="personUpdateLabel"
                     aria-hidden="true"
                     style="display: none;">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <form action="" id="personUpdateForm" data-id="" data-lead-id="">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="personUpdateLabel">
                                        Edit Person
                                    </h5>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-primary btn-person-load">
                                            <span class="d-flex align-items-center">
                                                <span class="flex-grow-1 me-2">Loading Data...</span>
                                                <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                    <span class="visually-hidden">Loading Data...</span>
                                                </span>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_first_name" class="form-group">
                                                    <label for="id_first_name" class="">
                                                        First name
                                                    </label>
                                                    <div>
                                                        <input type="text"
                                                               name="first_name"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_first_name">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_last_name" class="form-group">
                                                    <label for="id_last_name" class="">
                                                        Last name
                                                    </label>
                                                    <div>
                                                        <input type="text"
                                                               name="last_name"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_last_name">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 d-none">
                                            <div>
                                                <div id="div_id_company" class="form-group">
                                                    <label for="id_company">
                                                        Company
                                                    </label>
                                                    <div>
                                                        <input name="company" class="select form-control" id="id_company">
                                                    </input>
                                                </div>
                                            </div>
                                        </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_email" class="form-group">
                                                    <label for="id_email" class="">
                                                        Email
                                                    </label>
                                                    <div>
                                                        <input type="email"
                                                               name="email"
                                                               maxlength="254"
                                                               class="emailinput form-control"
                                                               id="id_email">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_email2" class="form-group">
                                                    <label for="id_email2" class="">
                                                        Email2
                                                    </label>
                                                    <div>
                                                        <input type="email"
                                                               name="email2"
                                                               maxlength="254"
                                                               class="emailinput form-control"
                                                               id="id_email2">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_email3" class="form-group">
                                                    <label for="id_email3" class="">
                                                        Email3
                                                    </label>
                                                    <div>
                                                        <input type="email"
                                                               name="email3"
                                                               maxlength="254"
                                                               class="emailinput form-control"
                                                               id="id_email3">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_linkedin" class="form-group">
                                                    <label for="id_linkedin" class="">
                                                        Linkedin
                                                    </label>
                                                    <div>
                                                        <input type="text"
                                                               name="linkedin"
                                                               maxlength="1000"
                                                               class="textinput textInput form-control"
                                                               id="id_linkedin">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_city" class="form-group">
                                                    <label for="id_city" class="">
                                                        City
                                                    </label>
                                                    <div>
                                                        <input type="text"
                                                               name="city"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_city">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_state" class="form-group">
                                                    <label for="id_state" class="">
                                                        State
                                                    </label>
                                                    <div>
                                                        <input type="text"
                                                               name="state"
                                                               maxlength="200"
                                                               class="textinput textInput form-control"
                                                               id="id_state">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_country" class="form-group">
                                                    <label for="id_country" class=" requiredField">
                                                        Country<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="country" class="lazyselect form-control" id="id_country">
                                                            <option value="" selected="">
                                                                -----------------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_status" class="form-group">
                                                    <label for="id_status" class=" requiredField">
                                                        Status<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="status" class="select form-control" id="id_status">
                                                            <option value="1" selected="">
                                                                New
                                                            </option>
                                                            <option value="2">
                                                                Email Not Found
                                                            </option>
                                                            <option value="3">
                                                                Contacted
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-update-person">
                                        Update
                                    </button>
                                    <button type="button" class="btn btn-primary btn-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- Modal FORM for ADD CSV Leads -->
                <div id="csvLead"
                     class="modal fade"
                     tabindex="-1"
                     aria-labelledby="csvLeadLabel"
                     aria-hidden="true"
                     style="display: none;">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form action="" id="csvLeadForm" data-job="" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="csvLeadLabel">
                                        Create Leads through CSV
                                    </h5>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close">
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_csv" class="form-group">
                                                    <p align="right">
                                                        <a href="{% static 'samplefiles/create_lead_sample_file.csv' %}"
                                                           download="">Download SampleFile</a>
                                                    </p>
                                                    <label for="id_csv" class="">
                                                        CSV
                                                    </label>
                                                    <div>
                                                        <input type="file" name="csv" class="file form-control" id="id_csv" required/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 offset-lg-4">
                                            <ul class="list-group list-group-flush text-center">
                                                <li class="list-group-item list-group-fill-light">
                                                    Report
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-created">0</span> Created
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-failed">0</span> Not Created
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-bulk-create">
                                        Create Lead
                                    </button>
                                    <button type="button" class="btn btn-primary btn-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- End Modal FORM for  CSV Leads -->
            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
        {% block footer %}
            {% include "partials/footer.html" %}
        {% endblock footer %}
    </div>
    <!-- end main content-->
{% endblock content %}
{% block extra_js %}
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <!--datatable js-->
    <script src="{% static 'js/DataTables/datatables.min.js' %}"></script>
    <script src="{% static 'js/moment-2.29.2.min.js' %}"></script>
    <script>
    window.onload = function(){
        localStorage.clear();
    }
    var leadTableParams = {}
    var table = $('#leadsTable').DataTable( {
        serverSide: true,
        processing: true,
        order: [[6, 'desc']],
        "ajax": {
            "url": "/api/lead/?format=datatables",
            "data": function ( d ) {
                return  $.extend(d, leadTableParams);
            }
        },
        "dom": '<"top"lrtip<"clear">>rt',
        "columnDefs": [
        {
            // Hide the ID column
            targets: 0,
            visible: false,
            searchable: false,
        },
        {
            // Person first_name column
            targets: 1,
            className: "person-first_name",
            createdCell: (td, cellData, rowData, row, col) =>{
                $(td).attr('data-id', rowData.person_id); 
            },
        },
        {
            // Person last_name column
            targets: 2,
            className: "person-last_name",
            createdCell: (td, cellData, rowData, row, col) =>{
                $(td).attr('data-id', rowData.person_id); 
            },
        },
        {
            // Person email column
            targets: 3,
            className: "person-email",
            createdCell: (td, cellData, rowData, row, col) =>{
                $(td).attr('data-id', rowData.person_id); 
            },
            render: (data, type, row) => {
                return `
                <div class="d-flex align-content-between">
                    ${ row.person.email || '' }
                    <br>
                    ${ row.person.email2 || '' }
                    <br>
                    ${ row.person.email3 || '' }
                    <ul class="list-inline hstack gap-2 mb-0">
                        <li class="list-inline-item edit ps-2" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Edit">
                        <a href="javascript:void(0)" data-id="${ row.person.id }" class="text-primary d-inline-block person-edit-btn" data-bs-toggle="modal" data-bs-target="#personUpdate">
                            <i class="ri-pencil-fill fs-16"></i>
                        </a>
                        </li> 
                    </ul>
                </div> `
            }
        },
        {
            // Company name column
            targets: 4,
            defaultContent: '-',
            
        },
        {
            // Status column
            targets: 5,
            render: (data, type, row) => {
                return `
                <div class="d-flex align-content-between">
                    <span class="lead-status" data-id="${ row.id }">${ row.status }</span>
                    <ul class="list-inline hstack gap-2 mb-0">
                        <li class="list-inline-item  ps-2" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Change Status">
                        <a href="javascript:void(0)" data-id="${ row.id }" class="text-primary d-inline-block change-status-btn" data-bs-toggle="modal" data-bs-target="#changeStatus">
                            <i class="ri-pencil-fill fs-16"></i>
                        </a>
                        </li> 
                    </ul>
                </div>`
            }
        },
        {
            // Created column
            targets: 6,
            render: (data, type, row)=>{
                return moment(row.created).format('MMM DD, YYYY hh:mm A');
            }
        },
        {
            // Jobpost city column
            targets: 7,
            defaultContent: '-',
            
        },
        {
            // Jobpost state column
            targets: 8,
            defaultContent: '-',
            
        },
        {
            // Jobpost country column
            targets: 9,
            defaultContent: '-',
            
        },
        {
            // Jobpost title column
            targets: 10,
            defaultContent: '-',
            
        },
        {
            // Person Designation column
            targets: 11,
            defaultContent: '-',
            
        },
        {
            // Person linkedin column
            targets: 12,
            defaultContent: '-',
            visible: false,
            
        },
        {
            // Jobpost url column
            targets: 13,
            defaultContent: '-',
            visible: false,
            
        },
        {
            targets: -1,  // -1 is the last column, 0 the first, 1 the second, etc.
            sortable: false,
            searchable: false,
            // The `data` parameter refers to the data for the cell.
            // The `rows`argument is an object representing all the data for the current row.
            render: ( data, type, row ) => {
                let viewLeadURL = "{% url 'leads:lead_detail' pk=0 %}"
                let editLeadURL = "{% url 'leads:lead_edit' pk=0 %}"
                let deleteLeadURL = "{% url 'leads:lead_delete' pk=0 %}"
                
                let actions =  `<ul class="list-inline hstack gap-2 mb-0">`
                    if(row.person.linkedin){
                        let link = (row.person.linkedin.indexOf('://') === -1) ? 'http://' + row.person.linkedin : row.person.linkedin;
                        actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="LinkedIn">
                        <a href="${link}" target="__blank" class="text-primary d-inline-block">
                            <i class="ri-linkedin-fill fs-16"></i>
                        </a>
                        </li>`
                    }
                    if (row.job_post){
                        if(row.job_post.url){
                            let link = (row.job_post.url.indexOf('://') === -1) ? 'http://' + row.job_post.url : row.job_post.url;
                            actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Job_post_link">
                            <a href="${link}" target="__blank" class="text-success d-inline-block">
                                <i class="ri-linkedin-fill fs-16"></i>
                            </a>
                            </li>`
                        }
                    }

                    {% if perms.leads.change_lead %}
                    actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="View">
                    <a href="${viewLeadURL.replace('0', row.id)}" class="text-primary d-inline-block">
                        <i class="ri-eye-fill fs-16"></i>
                    </a>
                    </li>`
                    {% endif %}

                    {% if perms.leads.change_lead %}
                        actions += `<li class="list-inline-item edit" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Edit">
                        <a href="${editLeadURL.replace('0', row.id)}" class="text-primary d-inline-block edit-item-btn">
                            <i class="ri-pencil-fill fs-16"></i>
                        </a>
                        </li>`
                    {% endif %}

                    actions += `<li class="list-inline-item edit" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Change Status">
                    <a href="#StatusChange"  class="change-status d-inline-block edit-item-btn ${row.status==="Sent"?"text-muted":"text-primary"}" style="${row.status==="Sent"?'pointer-events:none;' : ''}" data-lead_id='${row.id}'>
                    <i class="ri-hammer-fill fs-16"></i>
                    </a>
                    </li>`

                    {% if perms.leads.delete_lead %}
                        actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Remove">
                        <a class="delete-btn text-danger d-inline-block remove-item-btn" data-bs-toggle="modal" href="#deleteOrder" data-url="${deleteLeadURL.replace('0', row.id)}">
                        <i class="ri-delete-bin-5-fill fs-16"></i>
                        </a>
                        </li>`
                    {% endif %}

                actions += `</ul>`
                return actions
            },
        }]
    } );
$(document).ready(function(){
    {% if user.get_role_display != 'Applicant' %}        $('.form_class > div').removeClass('d-none');{% endif %}

    const statusChoices = new Choices(document.querySelector('#id_lead_status'),{
        shouldSort: false
    })
    const sourceChoices = new Choices(document.querySelector('#id_source'),{
        shouldSort: false
    })
    const robotChoices = new Choices(document.querySelector('#id_sales_task__robot'),{
        shouldSort: false
    })
    const teamChoices = new Choices(document.querySelector('#id_sales_task__robot__team'),{
        shouldSort: false
    })
    const userChoices = new Choices(document.querySelector('#id_user'),{
        shouldSort: false,
        searchResultLimit: 50
    })
    const salesTaskChoices = new Choices(document.querySelector('#id_sales_task'),{
        shouldSort: false,
        searchResultLimit: 50
    })
    const countryChoices = new Choices(document.querySelector('#id_person__country'),{
        shouldSort: false
    })
    const outboundEmailChoices = new Choices(document.querySelector('#id_outbound_email'),{searchResultLimit: 50})

    const resumeSentChoices = new Choices(document.querySelector('#id_resume_sent'),{
        shouldSort: false
    });
    const contractSignedChoices = new Choices(document.querySelector('#id_contract_signed'),{
        shouldSort: false
    });
    const botLeadChoices = new Choices(document.querySelector('#id_bot_lead'),{
        shouldSort: false
    });
    const personCountryChoices = new Choices(document.querySelector('#id_country'),{
        shouldSort: false
    });
    const personStatusChoices = new Choices(document.querySelector('#id_status'),{
        shouldSort: false
    });

    const outboundEmailElement = document.getElementById('id_outbound_email');
    const salesTaskElement = document.getElementById('id_sales_task');
    const userElement = document.getElementById('id_user');
    const companyElement = document.getElementById('id_company');

    var lead_data_progress = 0;
    var person_data_progress = 0;
    $('#btn_export_csv').click(function(){
        $('.btn-export-load').removeClass('d-none');
        $.ajax({
            type: "GET",
            url: '/api/lead/export-csv/',
            data: leadTableParams,
            success: function(response){
            // Create a Blob object with the CSV data
            var blob = new Blob([response], { type: 'text/csv' });

            // Create a URL for the Blob
            var url = window.URL.createObjectURL(blob);

            // Create an <a> element for downloading
            var a = document.createElement('a');
            a.href = url;
            a.download = 'exported_data.csv';

            // Trigger a click event to initiate the download
            a.click();

            // Clean up
            window.URL.revokeObjectURL(url);
            $('.btn-export-load').addClass('d-none');
            },
            error: function(){
                Toastify({
                    text: 'Oops something went wrong',
                    className: "bg-danger"
                }).showToast();
                $('.btn-export-load').addClass('d-none');
            }
        })
    });
    
    $.ajax({
        type: "GET",
        url: '/api/source/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            sourceChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            sourceChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })
    $.ajax({
        type: "GET",
        url: '/api/robot/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            robotChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            robotChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })
    
    $.ajax({
        type: "GET",
        url: '/api/team/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            teamChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            teamChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })
    
    $.ajax({
        type: "GET",
        url: '/api/users/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
            userChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            userChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })
   
    $.ajax({
        type: "GET",
        url: '/api/salestask/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            salesTaskChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            salesTaskChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })
    
    $.ajax({
        type: "GET",
        url: '/leads/countrieslist/',
        data: {},
        success: function(response){
            newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
            countryChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            countryChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })

    $.ajax({
        type: "GET",
        url: '/api/outboundemail/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
            outboundEmailChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            outboundEmailChoices.setChoices(newChoices);
        },
        complete: function(){
            lead_data_progress+=1;
                if(lead_data_progress==7){
                    $('.btn-lead-load').addClass('d-none');
                }
            }
    })
    
    $('#leadsTable').on('click', '.change-status-btn', (event) => {
        event.preventDefault();
        let leadId = $(event.currentTarget).data('id')
        $('#changeStatusForm').data('id', leadId)
    });
    
    $('#changeStatusForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        let leadId = $(this).data('id')
        var form = $(this);
        $.ajax({
            type: "PATCH",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/lead/${leadId}/`,
            data: {'status': $('select[name="change_status"]').val()}, // serializes the form's elements.
            success: (response) => {
                // Show the success message
                Toastify({
                    text: "The status has been updated successfully",
                }).showToast();
                console.log(response)
                $(`.lead-status[data-id='${leadId}']`).text($('select[name="change_status"]').text())
                form.trigger("reset");
                $('.close-btn').trigger('click')
                table.ajax.reload(null, false)
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.log(err)
                Toastify({
                    text: err?.status || 'Oops something went wrong',
                    className: "bg-danger"
                }).showToast();
            }
        });
    })
    
    // Update the Delete URL in Delete Confirm Modal
    $('#leadsTable').on('click', '.delete-btn', (event) => {
        $('#delete-record').attr('href', $(event.currentTarget).data('url'))
    })
    
    // Load the person for edit mode in modal
    $('#leadsTable').on('click','.person-edit-btn',(event)=>{
        let personId = $(event.currentTarget).data('id')
        $('#personUpdateForm').data('id', personId)
        $.ajax({
            type: "GET",
            url: `/api/person/${personId}`,
            success: function(response){
                let textFields = ['first_name', 'last_name', 'email', 'email2', 'email3', 'linkedin', 'city', 'state', 'company']     
                textFields.forEach((field)=>{
                    $(`input[name='${field}']`).val(response[field])
                })
                $.ajax({
                    type: "GET",
                    url: '/leads/countrieslist/',
                    data: {},
                    success: function(response){
                        newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                        personCountryChoices.clearChoices()
                        newChoices.unshift({'value': '', 'label': '---------'})
                        personCountryChoices.setChoices(newChoices);
                    },
                    complete: function(){
                            personCountryChoices.setChoiceByValue(response['country']);
                        }
                    })
                    personStatusChoices.setChoiceByValue(String(response['status']));
                },
                complete: function(){
                    $('.btn-person-load').addClass('d-none');
            }
        }) 
    })


    // Reset the person form on close the modal
    const personUpdateModalEl = document.getElementById('personUpdate')
    personUpdateModalEl.addEventListener('hidden.bs.modal', event => {
        //$('#personUpdateForm').trigger('reset')
        table.ajax.reload(null, false)
    })

    // Handle Update Person
    $('#personUpdateForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('.btn-load').removeClass('d-none');
        $('.btn-update-person').addClass('d-none');
        var form = $(this);
        let personId = form.data('id')
        $.ajax({
            type: "PUT",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/person/${personId}/`,
            data: form.serialize(), // serializes the form's elements.
            success: (response) => {
               
                // Update the data in leads table
                $(`.person-first_name[data-id='${personId}']`).text(response.first_name)
                $(`.person-last_name[data-id='${personId}']`).text(response.last_name)
                $(`.person-email[data-id='${personId}']`).text(response.email)
                $(`.person-email[data-id='${personId}']`).text(response.email2)
                $(`.person-email[data-id='${personId}']`).text(response.email3)
                $('.btn-load').addClass('d-none');
                $('.btn-update-person').removeClass('d-none');
                //form.trigger("reset");
                $('.close-btn').trigger('click')
                table.ajax.reload(null, false)
                                // Show the success message
                Toastify({
                    text: "The person has been updated successfully",
                }).showToast();
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.log(err)
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `${field}: ${err[field]}`,
                            className: 'bg-danger',
                            style: {
                              'text-transform': "capitalize",
                            },
                        }).showToast();
                    })

                } else {
                    Toastify({
                      text: "Oops something went wrong.",
                      className: 'bg-danger'
                    }).showToast();
                }
                $('.btn-load').addClass('d-none');
                $('.btn-update-person').removeClass('d-none');
            }
        });
    })
    
// Filters for Lead table

    // Search input
    document.getElementById('btn-search').addEventListener('click', function() {
        let searchInput = document.getElementById('id_search').value;
        leadTableParams.search = searchInput
        table.ajax.reload(null, false)
    });
   

    // Handle OnChange for Status Filter
    statusChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.status = event.detail.value;
        table.ajax.reload(null, false);
    },
    false,
    );

    // Handle OnChange for Country Filter
    countryChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        leadTableParams.person__country = event.detail.value
        table.ajax.reload(null, false)
        },
    false,
    );

    // Handle OnChange for Robot Filter
    robotChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.sales_task__robot = event.detail.value
        table.ajax.reload(null, false)
        
        // Load the outbound email filter for this robot
        fetch(`/api/outboundemail/?robot=${event.detail.value}`)
        .then((response) => response.json())
        .then((response) => {
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
            outboundEmailChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            outboundEmailChoices.setChoices(newChoices)
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    },
    false,
    );

    // Handle OnChange for Team Filter
    teamChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.sales_task__robot__team = event.detail.value
        table.ajax.reload(null, false)
        
        // Load the outbound email filter for this robot
        fetch(`/api/outboundemail/?robot__team=${event.detail.value}`)
        .then((response) => response.json())
        .then((response) => {
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
            outboundEmailChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            outboundEmailChoices.setChoices(newChoices)
        })
        .catch((error) => {
            console.error('Error:', error);
        });
        
    },
    false,
    );

    // Handle OnChange for User Filter
    userChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.user = event.detail.value;
        table.ajax.reload(null, false)
    },
    false,
    );

    // Handle OnChange for Source Filter
    sourceChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.source = event.detail.value;
        table.ajax.reload(null, false)
    },
    false,
    );
    
    // Handle OnChange for Resume Sent Filter
    resumeSentChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.resume_sent = event.detail.value;
        table.ajax.reload(null, false)
    },
    false,
    );
    
    // Handle OnChange for Outbound Email Filter
    outboundEmailChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.outbound_email = event.detail.value;
        table.ajax.reload(null, false)
    },
    false,
    );
    
    

    // Handle OnChange for Sales Task Filter
    salesTaskChoices.passedElement.element.addEventListener(
        'change',
        function(event) {
            //values = Array.from(salesTaskElement).map(element => element.value);
            leadTableParams.sales_task = event.detail.value
            table.ajax.reload(null, false)
        },
        false,
    );
    
    

     // Handle OnChange for Bot lead Filter
    botLeadChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        leadTableParams.bot_lead = event.detail.value;
        table.ajax.reload(null, false)
    },
    false,
    );
    
    // Handle OnChange for Contract Signed Filter
    contractSignedChoices.passedElement.element.addEventListener(
    'change',
    function(event) {
        // get the all person that are part of selected company and update the choices in person dropdown
        leadTableParams.contract_signed = event.detail.value;
        table.ajax.reload(null, false)
    },
    false,
    );


    var ajax_outboundEmail = null;
    outboundEmailElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_outboundEmail != null){
            ajax_outboundEmail.abort();
            ajax_outboundEmail = null
          }
          let input = event.detail.value
          outboundEmailChoices.clearChoices();
          ajax_outboundEmail = $.ajax({
                type: "GET",
                url: `/api/outboundemail/?action=dropdown&search=${input}`,
                success: function(response){
                    if(response.count > 0){
                        newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
                        outboundEmailChoices.clearChoices()
                        newChoices.unshift({'value': '', 'label': '---------'})
                        outboundEmailChoices.setChoices(newChoices);
                    }
                },
            })
        },
        false,
      );

      var ajax_SalesTask = null;
      salesTaskElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_SalesTask != null){
            ajax_SalesTask.abort();
            ajax_SalesTask = null
          }
          let input = event.detail.value
          salesTaskChoices.clearChoices();
          ajax_SalesTask = $.ajax({
                type: "GET",
                url: `/api/salestask/?action=dropdown&search=${input}`,
                    success: function(response){
                        if(response.count > 0){
                            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                            salesTaskChoices.clearChoices()
                            newChoices.unshift({'value': '', 'label': '---------'})
                            salesTaskChoices.setChoices(newChoices);
                        }
                    },

                })
        },
        false,
      );
      var ajax_user = null;
      userElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_user != null){
            ajax_user.abort();
            ajax_user = null
          }
          let value = event.detail.value;
          userChoices.clearChoices();
          ajax_user = $.ajax({
                type: "GET",
                url: `/api/users/?action=dropdown&search=${value}`,
                    success: function(response){
                        if(response.count > 0){
                            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
                            userChoices.clearChoices()
                            newChoices.unshift({'value': '', 'label': '---------'})
                            userChoices.setChoices(newChoices);
                        }
                    },

                })
        },
        false,
      );    

    // Date Range Picker Filter
    const dateRangePicker = flatpickr("#id_date_range", {
        mode: 'range',
        onChange: (selectedDates, dateStr, instance) => {
            //...
            if(selectedDates.length > 1) {
                // Set the required date format
                let start_date = moment(selectedDates[0]).format('YYYY-MM-DD')
                let end_date = moment(selectedDates[1]).format('YYYY-MM-DD')
                // Set the datatables get params and reload the data
                leadTableParams.start_date = start_date
                leadTableParams.end_date = end_date
                table.ajax.reload(null, false);
            }
        }
    })




    $('#clearDateRange').click(function(e){
        
        // Clear the Date Range Picker Filter
        $('#id_date_range')[0]._flatpickr.clear()
        
        // Clear the values for datatable get params and reload the data
        leadTableParams.start_date = ''
        leadTableParams.end_date = ''
        table.ajax.reload(null, false)
    })
    
    
    // Bulk Create Leads from Csv
    $('#csvLeadForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        
        $('.btn-load').removeClass('d-none');
        $('.btn-bulk-create').addClass('d-none');
        
        var form = $(this);
        var formData = new FormData(form[0]);
        let leadId = form.data('lead')
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/lead/bulk-create-csv/`,
            data: formData, // serializes the form's elements.
            contentType: false, //this is requireded please see answers above
            processData: false,
            success: function(response)
            {
                $('.btn-load').addClass('d-none');
                $('.btn-bulk-create').removeClass('d-none');
                console.log(response); // show response from the php script.
                table.ajax.reload(null, false);
                form.trigger("reset");
                $('.total-created').text(response?.created || 0)
                $('.total-failed').text(response?.failed || 0)
                if (response.status === 'error'){
                    Toastify({
                        text: response?.error || 0 ,
                        className: 'bg-danger'
                    }).showToast();
                }
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.log(err)
                Toastify({
                    text: err?.status || 'Oops something went wrong',
                    className: "bg-danger"
                }).showToast();
                $('.btn-load').addClass('d-none');
                $('.btn-bulk-create').removeClass('d-none');
            }
        });
    })
    
});

$('#leadsTable').on('click', '.change-status',function(){
    let leadId =$(this).data('lead_id')
    $.ajax({
        type: "PATCH",
        headers: { "X-CSRFToken": '{{csrf_token}}' },
        url: `/api/lead/${leadId}/`,
        data: {'status': 5},
        success: function(response){
            console.log(response)
            table.ajax.reload(null, false)
        }
    });
});

    </script>
{% endblock extra_js %}
