{% extends 'layouts/base.html' %}

{% block title %}
  Messages
{% endblock %}
{% block content %}
  <div class="header bg-primary pb-6">
    <div class="container-fluid">
      <div class="header-body">
        <div class="row align-items-center py-4">
          <div class="col-lg-6 col-7">
            <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
              <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                <li class="breadcrumb-item">
                  <a href="/"><i class="fas fa-home"></i></a>
                </li>
              </ol>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Page content -->
  <div class="container-fluid mt--5">
    <div class="row">
      <div class="col-xl-12 order-xl-1">
        <div class="card">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="col-8">
                <h3 class="mb-0">Messages</h3>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="pl-lg-4">
              <div class="row">
                <div class="col-lg-12">
                  <textarea class="form-control" readonly id="message_textarea" rows="10">
                    {% for message in conversation %}
                      {{ message }}
                    {% endfor %}
                  </textarea>
                </div>
              </div>
            </div>
            <form id="message_form" class="mt-4">
              {% csrf_token %}
              <div class="pl-lg-4">
                <div class="row">
                  <div class="col-lg-12">
                    <div class="form-group">
                      <input type="text" class="form-control" id="id_message" placeholder="Message" name="message" required />
                      <input type="hidden" name="sender" value="{{ user.id }}" />
                      <input type="hidden" name="receiver" value="{{ receiver }}" />
                    </div>
                  </div>
                </div>
              </div>
              <hr class="my-4" />
              <div class="col-lg-4">
                <button type="submit" class="btn btn-primary"><span>Send</span></button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% include 'includes/footer.html' %}
  </div>
{% endblock %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
  <script>
    $(document).ready(function () {
      // Example JavaScript code to establish WebSocket connection and send/receive messages
      const socket = new WebSocket('ws://localhost:8000/ws/chat/1/')
    
      socket.onopen = () => {
        console.log('WebSocket connection established.')
      }
    
      socket.onmessage = (event) => {
        const message = JSON.parse(event.data).message
        debugger
        console.log('Received message:', message)
      }
    
      function sendMessage(message) {
        debugger
        socket.send(JSON.stringify({ message: message }))
      }
    
      $('#message_form').on('submit', function (e) {
        e.preventDefault()
        $.ajax({
          type: 'POST',
          url: "{% url 'messaging:send_message' %}",
          data: $(this).serialize(),
          success: function (data) {
            $('#id_message').val('')
            var message = data.message
            // Append the message to the textarea
            $('#message_textarea').val(function (i, text) {
              debugger
              return 'You: ' + message + '\n'
            })
          }
        })
      })
    })
  </script>
{% endblock %}
