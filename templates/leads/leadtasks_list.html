{% extends "partials/base.html" %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% load static %}
{% block title %}
    Lead Tasks List
{% endblock title %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{% static 'js/DataTables/datatables.min.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="Leads" title="Lead Tasks List" %}
                {% endblock pagetitle %}
                {% include "partials/messages.html" %}
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card"  id="tasksList">
                            <div class="card-header border-0">
                                <div class="d-flex align-items-center">
                                    <h5 class="card-title mb-0 flex-grow-1">Lead Tasks</h5>
                                    <div class="flex-shrink-0">
                                        <a class="btn btn-primary csv-bulk"
                                                   href="javascript:void(0)"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#csvLeadTasks">CSV Upload</a>
                                        <button type="button" class="btn btn-primary btn-load d-none">
                                            <span class="d-flex align-items-center">
                                                <span class="flex-grow-1 me-2">Loading Data...</span>
                                                <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                    <span class="visually-hidden">Loading Data...</span>
                                                </span>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body border border-dashed border-end-0 border-start-0">
                                <form>
                                    {% include 'leads/partials/leadtasks_filter.html' %}
                                </form>
                            </div>
                            <!--end card-body-->
                            <div class="d-flex justify-content-end">
                            {% if perms.leads.delete_leadtasks %}
                                <a class="btn btn-danger disabled delete-lead-tasks float-end m-2"
                                            href="javascript:void(0)"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteSelectedTasksModal">Delete Lead Tasks</a>
                            {% endif %}
                            {% if perms.leads.change_leadtasks %}
                                <a class="btn btn-success disabled assign-lead-tasks float-end m-2"
                                            href="javascript:void(0)"
                                            data-bs-toggle="modal"
                                            data-bs-target="#assignLeadTasks">Assign Lead Tasks</a>
                            {% endif %}
                            </div>
                            <div class="card-body">
                                <div class="table-responsive table-card mb-4">
                                    <table class="table align-middle table-nowrap mb-0" id="leadtasksTable">
                                        <thead class="table-light text-muted">
                                            <tr>
                                                <th><input type="checkbox" id="selectAll"></th>
                                                <th data-data="id">ID</th>
                                                <th data-data="keyword">Keyword</th>
                                                <th data-data="location">Location</th>
                                                <th data-data="job_title">Job Title</th>
                                                <th data-data="job_link">Job Link</th>
                                                <th data-data="company">Company</th>
                                                <th data-data="company_link">Company Link</th>
                                                <th data-data="job_location">Job Location</th>
                                                <th data-data="post_time">Post Time</th>
                                                <th data-data="applicants_count">Applicants Count</th>
                                                <th data-data="seniority_level">Seniority Level</th>
                                                <th data-data="employment_type">Employment Type</th>
                                                <th data-data="job_function">Job Function</th>
                                                <th data-data="industries">Industries</th>
                                                <th data-data="created">Created</th>
                                                <th data-data="completed">Completed</th>
                                                <th data-data="assigned_to">Assigned To</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="list form-check-all">
                                        </tbody>
                                    </table>
                                    <!--end table-->
                                </div>
                            </div>
                            <!--end card-body-->
                        </div>
                        <!--end card-->
                    </div>
                    <!--end col-->
                </div>
                <!--end row-->
                <div class="modal fade flip"
                     id="deleteOrder"
                     tabindex="-1"
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body p-5 text-center">
                                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                <div class="mt-4 text-center">
                                    <h4>You are about to delete ?</h4>
                                    <p class="text-muted fs-14 mb-4">
                                        Deleting your task will remove all of
                                        your information from our database.
                                    </p>
                                    <div class="hstack gap-2 justify-content-center remove">
                                        <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none"
                                                data-bs-dismiss="modal">
                                            <i class="ri-close-line me-1 align-middle"></i> Close
                                        </button>
                                        <a class="btn btn-danger" id="delete-record">Yes, Delete It</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end delete modal -->
                <div class="modal fade flip"
                     id="deleteSelectedTasksModal"
                     tabindex="-1"
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body p-5 text-center">
                                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                <div class="mt-4 text-center">
                                    <h4>You are about to delete ?</h4>
                                    <p class="text-muted fs-14 mb-4">
                                        Deleting your task will remove all of
                                        your information from our database.
                                    </p>
                                    <div class="hstack gap-2 justify-content-center remove">
                                        <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none"
                                                data-bs-dismiss="modal">
                                            <i class="ri-close-line me-1 align-middle close-delete-tasks-btn"></i> Close
                                        </button>
                                        <a class="btn btn-danger" id="delete-selected-tasks">Yes, Delete It</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end delete modal -->
                <!-- Modal FORM for Assign Tasks -->
                <div id="assignLeadTasks"
                     class="modal fade"
                     tabindex="-1"
                     aria-labelledby="assignLeadTasksLabel"
                     aria-hidden="true"
                     style="display: none;">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content">
                            <form action="" id="assignLeadTasksForm" data-leadtasks="">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="assignLeadTasksLabel">Assign Lead Tasks</h5>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-primary btn-user-load">
                                            <span class="d-flex align-items-center">
                                                <span class="flex-grow-1 me-2">Loading Data...</span>
                                                <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                    <span class="visually-hidden">Loading Data...</span>
                                                </span>
                                            </span>
                                        </button>
                                    </div>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_user" class="form-group">
                                                    <label for="id_user" class=" requiredField">
                                                        User<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="user"
                                                                class="form-control"
                                                                required
                                                                id="id_user">
                                                            <option value="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">
                                        Assign
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- Modal FORM for ADD CSV Leads -->
                <div id="csvLeadTasks"
                     class="modal fade"
                     tabindex="-1"
                     aria-labelledby="csvLeadTasksLabel"
                     aria-hidden="true"
                     style="display: none;">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <form action="" id="csvLeadTasksForm" data-job="" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="csvLeadTasksLabel">
                                        Create Lead Tasks through CSV
                                    </h5>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close">
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_csv" class="form-group">
                                                    <p align="right">
                                                        <a href="{% static 'samplefiles/lead_tasks.csv' %}"
                                                           download="">Download SampleFile</a>
                                                    </p>
                                                    <label for="id_csv" class="">
                                                        CSV
                                                    </label>
                                                    <div>
                                                        <input type="file" name="csv" class="file form-control" id="id_csv" required/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-4 offset-lg-4">
                                            <ul class="list-group list-group-flush text-center">
                                                <li class="list-group-item list-group-fill-light">
                                                    Report
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-created">0</span> Created
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-failed">0</span> Not Created
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-duplicate-in-csv">0</span> Duplicate Tasks in CSV
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-duplicate-tasks">0</span> Duplicate Tasks
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-duplicate-companies">0</span> Duplicate Companies
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total-blocked-companies">0</span> Blocked Companies
                                                </li>
                                                <li class="list-group-item">
                                                    <span class="total_blocked_leadtasks">0</span> Blocked Lead Tasks
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-bulk-create">
                                        Create Lead Tasks
                                    </button>
                                    <button type="button" class="btn btn-primary btn-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
                <!-- End Modal FORM for  CSV Leads -->
            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
        {% block footer %}
            {% include "partials/footer.html" %}
        {% endblock footer %}
    </div>
    <!-- end main content-->
{% endblock content %}
{% block extra_js %}
    <link href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css" rel="stylesheet">
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <!--datatable js-->
    <script src="{% static 'js/DataTables/datatables.min.js' %}"></script>
    <script src="{% static 'js/moment-2.29.2.min.js' %}"></script>
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
    <script>
    $(document).ready(function () {
        const userChoices = new Choices(document.querySelector('#id_user'), {searchResultLimit: 50})
        const assignedToChoices = new Choices(document.querySelector('#id_assigned_to'),{
            shouldSort: false,
            searchResultLimit: 50
        })
        const statusChoices = new Choices(document.querySelector('#id_completed'),{
            shouldSort: false
        });
        const assignedToElement = document.getElementById('id_assigned_to');
        const userElement = document.getElementById('id_user');


        var leadTasksTableParams = {
            completed: '',
            assigned_to: '',
        }

        var table = $('#leadtasksTable').DataTable({
            processing: true,
            serverSide: true,
            order: [[15, 'desc']],
            "ajax": {
                "url": "/api/leadtasks/?format=datatables",
                "data": function ( d ) {
                    return  $.extend(d, leadTasksTableParams);
                },
            },
            "dom": 'lrtip',
            "columnDefs": [
            {
                targets: 0,
                defaultContent: '-',
                sortable: false,
                searchable: false
            },
            {  
                targets: 1,
                visible: false
            },
            {
                targets: 2,
                defaultContent: '-',
                visible: false
            },
            {
                targets: 3,
                defaultContent: '-',
                visible: false
            },
            {
                targets: 4,
                defaultContent: '-',
            },
            {
                targets: 5,
                defaultContent: '-',
                visible: false,
            },
            {
                targets: 6,
                defaultContent: '-',
            },
            {
                targets: 7,
                defaultContent: '-',
                visible: false,
            },
            {
                targets: 8,
                defaultContent: '-',
            },
            {
                targets: 9,
                defaultContent: '-',
            },
            {
                targets: 10,
                defaultContent: '-',
            },
            {
                targets: 11,
                defaultContent: '-',
            },
            {
                targets: 12,
                defaultContent: '-',
            },
            {
                targets: 13,
                defaultContent: '-',
            },
            {
                targets: 14,
                defaultContent: '-',
            },
            {
                targets: 15,
                render: (data, type, row)=>{
                    return moment(row.created).format('MMM DD, YYYY hh:mm A');
                }
            },
            {
                targets: 16,
                visible: false
            },
            {
                targets: 17,
                defaultContent: '-',
                visible: false
            },
            {
                targets: -1,  // -1 is the last column, 0 the first, 1 the second, etc.
                sortable: false,
                searchable: false,
                // The `data` parameter refers to the data for the cell.
                // The `rows`argument is an object representing all the data for the current row.
                render: ( data, type, row ) => {
                    let viewLeadTasksURL = "{% url 'leads:leadtasks_details' pk=0 %}"
                    let editLeadTasksURL = "{% url 'leads:leadtasks_edit' pk=0 %}"
                    let deleteLeadTasksURL = "{% url 'leads:leadtasks_delete' pk=0 %}"
                    
                    let actions =  `<ul class="list-inline hstack gap-2 mb-0">`
                        if (row.job_link){
                            if(row.job_link){
                                let link = (row.job_link.indexOf('://') === -1) ? 'http://' + row.job_link : row.job_link;
                                actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Job Link">
                                <a href="${link}" target="__blank" class="text-success d-inline-block">
                                    <i class="ri-linkedin-fill fs-16"></i>
                                </a>
                                </li>`
                            }
                        }
                        if (row.company_link){
                            if(row.company_link){
                                let link = (row.company_link.indexOf('://') === -1) ? 'http://' + row.company_link : row.company_link;
                                actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Company Link">
                                <a href="${link}" target="__blank" class="text-primary d-inline-block">
                                    <i class="ri-linkedin-fill fs-16"></i>
                                </a>
                                </li>`
                            }
                        }
                        {% if perms.leads.view_leadtasks %}
                        actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="View Details">
                        <a href="${viewLeadTasksURL.replace('0', row.id)}" class="text-info d-inline-block">
                            <i class="ri-eye-fill fs-16"></i>
                        </a>
                        </li>`
                        {% endif %}
    
                        {% if perms.leads.change_leadtasks %}
                            actions += `<li class="list-inline-item edit" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Edit">
                            <a href="${editLeadTasksURL.replace('0', row.id)}" class="text-primary d-inline-block edit-item-btn">
                                <i class="ri-pencil-fill fs-16"></i>
                            </a>
                            </li>`
                        {% endif %}
     
                        {% if perms.leads.delete_leadtasks %}
                            actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Remove">
                            <a class="delete-btn text-danger d-inline-block remove-item-btn" data-bs-toggle="modal" href="#deleteOrder" data-url="${deleteLeadTasksURL.replace('0', row.id)}">
                            <i class="ri-delete-bin-5-fill fs-16"></i>
                            </a>
                            </li>`
                        {% endif %}
    
                    actions += `</ul>`
                    return actions
                },
            }
            ]
        });

    const selectAllCheckbox = document.querySelector('#selectAll');
    selectAllCheckbox.addEventListener('change', function () {
        var isChecked = $(this).prop('checked');
        if (isChecked) {
            table.rows({
                page: 'current'
              }).select();
        }
        else{
            table.rows({
                page: 'current'
            }).deselect();
        }
        updateAssignButtonState();
    });

    // Event handler for individual rows
    table.on('click', 'tbody tr', function (e) {
        e.currentTarget.classList.toggle('selected');
        updateAssignButtonState(); // Update button state based on selection
    });

    // Function to update the state of the assign button based on row selection
    function updateAssignButtonState() {
        if (table.rows('.selected').data().length > 0) {
            $('.assign-lead-tasks').removeClass('disabled');
            $('.delete-lead-tasks').removeClass('disabled');
        } else {
            $('.assign-lead-tasks').addClass('disabled');
            $('.delete-lead-tasks').addClass('disabled');
        }
        // Update the "select all" checkbox state based on row selection
        var allRowsSelected = table.rows({ selected: true }).count() === table.rows().count();
        $('#selectAllCheckbox').prop('checked', allRowsSelected);
    }

    $('.assign-lead-tasks').on('click', (event) => {
        var selectedIDs = table.rows('.selected').data().map(function(item) {
            return item.id;
        });
        var selectedIDsString = selectedIDs.join(',');
        $('#assignLeadTasksForm').data('leadtasks', selectedIDsString)
        $.ajax({
            type: "GET",
            url: '/api/users/?action=assigned_dropdown',
            success: function(response){
                newChoices = response.results.map((row) => ({    'value': row.id,
                'label': row.first_name + ' ' + '('+row.total_assigned+')' ?? ''
            }))
                userChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                userChoices.setChoices(newChoices);
            },
            complete: function(){
                $('.btn-user-load').addClass('d-none');
            }
        })
    })

    $("#assignLeadTasksForm").submit(function(e){
        e.preventDefault();
        var form = $(this);
        formData = form.serialize();
        // Get the values of leadtasks after submitting the form
        var leadtasksValues = $(this).data('leadtasks');
        // Include leadtasksJSON in the form data
        formData += '&leadtasks=' + encodeURIComponent(leadtasksValues);
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/leads/leadtasks/assign_tasks/`,
            data: formData,
            success: function(response)
            {
                console.log(response); // show response from the php script.
                if (response.status === 'success'){
                    Toastify({
                        text: response?.message || 0 ,
                        className: 'bg-sucess'
                    }).showToast();
                }
                $('.close-btn').trigger('click')
                selectAllCheckbox.checked = false;
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.log(err)
                Toastify({
                    text: err?.status || 'Oops something went wrong',
                    className: "bg-danger"
                }).showToast();
            }
        });
    })

    // Update the Delete URL in Delete Confirm Modal
    $('#leadtasksTable').on('click', '.delete-btn', (event) => {
        $('#delete-record').attr('href', $(event.currentTarget).data('url'))
    })

    $('#id_search').on( 'keyup', function () {
        table.search( this.value ).draw();
    });
    
    // Bulk Create Leads from Csv
    $('#csvLeadTasksForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        
        $('.btn-load').removeClass('d-none');
        $('.btn-bulk-create').addClass('d-none');
        
        var form = $(this);
        var formData = new FormData(form[0]);
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/leadtasks/`,
            data: formData, // serializes the form's elements.
            contentType: false, //this is requireded please see answers above
            processData: false,
            success: function(response)
            {
                $('.btn-load').addClass('d-none');
                $('.btn-bulk-create').removeClass('d-none');
                console.log(response); // show response from the php script.
                form.trigger("reset");
                $('.total-created').text(response?.created || 0)
                $('.total-failed').text(response?.failed || 0)
                $('.total-duplicate-in-csv').text(response?.total_duplicate_in_csv || 0)
                $('.total-duplicate-tasks').text(response?.total_duplicate_tasks || 0)
                $('.total-duplicate-companies').text(response?.total_duplicate_companies || 0)
                $('.total-blocked-companies').text(response?.total_blocked_companies || 0)
                $('.total_blocked_leadtasks').text(response?.total_blocked_leadtasks || 0)
                if (response.status === 'error'){
                    Toastify({
                        text: response?.error || 0 ,
                        className: 'bg-danger'
                    }).showToast();
                }
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.log(err)
                Toastify({
                    text: err?.status || 'Oops something went wrong',
                    className: "bg-danger"
                }).showToast();
                $('.btn-load').addClass('d-none');
                $('.btn-bulk-create').removeClass('d-none');
            }
        });
    })
    $(".close-btn").click(function(){
        table.ajax.reload(null, false);
    })

    // Handle OnChange for Assigned To Filter
    assignedToChoices.passedElement.element.addEventListener(
        'change',
        function(event) {
            leadTasksTableParams.assigned_to = event.detail.value;
            table.ajax.reload(null, false)
        },
        false,
    );

    // Handle OnChange for Status Filter
    statusChoices.passedElement.element.addEventListener(
        'change',
        function(event) {
            leadTasksTableParams.completed = event.detail.value;
            table.ajax.reload(null, false)
        },
        false,
    );

    $.ajax({
        type: "GET",
        url: '/api/users/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
            assignedToChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            assignedToChoices.setChoices(newChoices);
        },
        complete: function(){
            $('.btn-load').addClass('d-none');
        }
    })

    var ajax_user = null;
      userElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_user != null){
            ajax_user.abort();
            ajax_user = null
          }
          let value = event.detail.value;
          userChoices.clearChoices();
          ajax_user = $.ajax({
                type: "GET",
                url: `/api/users/?action=dropdown&search=${value}`,
                    success: function(response){
                        if(response.count > 0){
                            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
                            userChoices.clearChoices()
                            newChoices.unshift({'value': '', 'label': '---------'})
                            userChoices.setChoices(newChoices);
                        }
                    },

                })
        },
        false,
      );   

    var ajax_assignedTo = null;
      assignedToElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_assignedTo != null){
            ajax_assignedTo.abort();
            ajax_assignedTo = null
          }
          let value = event.detail.value;
          assignedToChoices.clearChoices();
          ajax_assignedTo = $.ajax({
                type: "GET",
                url: `/api/users/?action=dropdown&search=${value}`,
                    success: function(response){
                        if(response.count > 0){
                            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
                            assignedToChoices.clearChoices()
                            newChoices.unshift({'value': '', 'label': '---------'})
                            assignedToChoices.setChoices(newChoices);
                        }
                    },

                })
        },
        false,
      );   

    $('#delete-selected-tasks').on('click', function () { 
        var selectedRowsData = table.rows('.selected').data();
        if (selectedRowsData.length > 0) {
            // Extract the IDs or other necessary information from the selected rows
            var selectedIds = selectedRowsData.map(function (row) {
                return row.id; // Replace 'id' with the actual property name containing the unique identifier
            });
    
            // Convert selectedIds to a plain array
            var selectedIdsArray = $.map(selectedIds, function(value) {
                return value;
            });
            console.log(selectedIdsArray);
            // Make an AJAX request to delete the selected rows
            $.ajax({
                type: 'DELETE',
                headers: { "X-CSRFToken": '{{csrf_token}}' },
                url: '/api/leadtasks/delete_multiple',
                data: { ids: selectedIdsArray },
                success: function (response) {
                    // Handle success, e.g., show a success message
                    Toastify({
                        text: "Success: " + response.message,
                        className: "bg-success"
                    }).showToast();
                    $('.close-delete-tasks-btn').trigger('click');
                    table.ajax.reload(null, false);
                    selectAllCheckbox.checked = false;
                },
                error: function (error) {
                    // Handle error, e.g., show an error message
                    console.error('Error deleting rows:', error);
                }
            });
        }
    });
});
    </script>
{% endblock extra_js %}
