{% extends "partials/base.html" %}
{% load static %}
{% block title %}
    Company List
{% endblock title %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{% static 'js/DataTables/datatables.min.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="Leads" title="Company List" %}
                {% endblock pagetitle %}
                {% include "partials/messages.html" %}
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card"  id="tasksList">
                            <div class="card-header border-0">
                                <div class="d-flex align-items-center">
                                    <h5 class="card-title mb-0 flex-grow-1">All Companies</h5>
                                    <div class="flex-shrink-0">
                                        {% if perms.leads.add_company %}
                                            <a role="button"
                                               href="{% url 'leads:company_create' %}"
                                               class="btn btn-danger add-btn">
                                                <i class="ri-add-line align-bottom me-1"></i> Create Company
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body border border-dashed border-end-0 border-start-0">
                                <form>
                                    {% include 'leads/partials/company_filter.html' %}
                                </form>
                            </div>
                            <div class="d-flex justify-content-end">
                                {% if perms.leads.change_leadtasks %}
                                    <a class="btn btn-success disabled assign-companies float-end m-2"
                                                href="javascript:void(0)"
                                                data-bs-toggle="modal"
                                                data-bs-target="#assignCompanies">Assign Companies</a>
                                {% endif %}
                                </div>
                            <!--end card-body-->
                            <div class="card-body">
                                <div class="table-responsive table-card mb-4">
                                    <table class="table align-middle table-nowrap mb-0" id="tasksTable">
                                        <thead class="table-light text-muted">
                                            <tr>
                                                <th><input type="checkbox" id="selectAll"></th>
                                                <th data-data="id" data-name="id">ID</th>
                                                <th data-data="name" data-name="name">Name</th>
                                                <th data-data="domain" data-name="domain">Domain</th>
                                                <th data-data="created" data-name="created">Created</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="list form-check-all">
                                        </tbody>
                                    </table>
                                    <!--end table-->
                                </div>
                            </div>
                            <!--end card-body-->
                        </div>
                        <!--end card-->
                    </div>
                    <!--end col-->
                </div>
                <!--end row-->
                <div class="modal fade flip"
                     id="deleteOrder"
                     tabindex="-1"
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-body p-5 text-center">
                                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                <div class="mt-4 text-center">
                                    <h4>You are about to delete ?</h4>
                                    <p class="text-muted fs-14 mb-4">
                                        Deleting your task will remove all of
                                        your information from our database.
                                    </p>
                                    <div class="hstack gap-2 justify-content-center remove">
                                        <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none"
                                                data-bs-dismiss="modal">
                                            <i class="ri-close-line me-1 align-middle"></i> Close
                                        </button>
                                        <a class="btn btn-danger" id="delete-record">Yes, Delete It</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end delete modal -->
                <!-- Modal FORM for Assign Tasks -->
                <div id="assignCompanies"
                     class="modal fade"
                     tabindex="-1"
                     aria-labelledby="assignCompaniesLabel"
                     aria-hidden="true"
                     style="display: none;">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content">
                            <form action="" id="assignCompaniesForm" data-companies="">
                                {% csrf_token %}
                                <div class="modal-header">
                                    <h5 class="modal-title" id="assignCompaniesLabel">Assign Companies</h5>
                                    <div class="flex-shrink-0">
                                        <button type="button" class="btn btn-primary btn-user-load">
                                            <span class="d-flex align-items-center">
                                                <span class="flex-grow-1 me-2">Loading Data...</span>
                                                <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                    <span class="visually-hidden">Loading Data...</span>
                                                </span>
                                            </span>
                                        </button>
                                    </div>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_user" class="form-group">
                                                    <label for="id_user" class=" requiredField">
                                                        User<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="user"
                                                                class="form-control"
                                                                required
                                                                id="id_user">
                                                            <option value="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">
                                        Assign
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- /.modal-content -->
                    </div>
                    <!-- /.modal-dialog -->
                </div>
                <!-- /.modal -->
            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
        {% block footer %}
            {% include "partials/footer.html" %}
        {% endblock footer %}
    </div>
    <!-- end main content-->
{% endblock content %}
{% block extra_js %}
<link href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css" rel="stylesheet">
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<!--datatable js-->
<script src="{% static 'js/DataTables/datatables.min.js' %}"></script>
<script src="{% static 'js/moment-2.29.2.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script>
$(document).ready(function () {

    const assignedToChoices = new Choices(document.querySelector('#id_assigned_to'),{
        shouldSort: false,
        searchResultLimit: 50
    })
    const companiesChoices = new Choices(document.querySelector('#id_companies'),{
        shouldSort: false
    })
    
    const statusChoices = new Choices(document.querySelector('#id_status'),{
        shouldSort: false
    })

    const assignedToElement = document.getElementById('id_assigned_to');
    const userElement = document.getElementById('id_user');

    $('#tasksTable').on('click', '.delete-btn', (event) => {
        $('#delete-record').attr('href', $(event.currentTarget).data('url'))
    })
    const userChoices = new Choices(document.querySelector('#id_user'), {searchResultLimit: 50})
    var tableParams = {
        'assigned_to': false,
        'status': 1,
    }
    var table = $('#tasksTable').DataTable({
        serverSide: true,
        processing: true,
        order: [[4, 'desc']],
        "ajax": {
            "url": "/api/company/?format=datatables",
            "data": function ( d ) {
                return  $.extend(d, tableParams);
            },
        },
        "dom": 'lrtip',
        "columnDefs": [
        {
            targets: 0,
            defaultContent: '-',
            sortable: false,
            searchable: false
        },
        {
            targets: 1,
            visible: true,
            searchable: true,
        },

        {
            targets: 2,
            defaultContent: '-',
        },

        {
            targets: 3,
            defaultContent: '-',
        },
        {
            targets: 4,
            render: (data, type, row)=>{
                return moment.utc(row.created).format('MMM DD, YYYY hh:mm A');
            }
        },
        {
            targets: -1,
            searchable: false,
            sortable: false,
            render: ( data, type, row ) => {
                let viewLeadURL = "{% url 'leads:company_details' pk=0 %}"
                let editLeadURL = "{% url 'leads:company_edit' pk=0 %}"
                let deleteLeadURL = "{% url 'leads:company_delete' pk=0 %}"
                
                let actions =  `<ul class="list-inline hstack gap-2 mb-0">`

                {% if perms.leads.view_person %}
                actions += `<li class="list-inline-item view" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="view">
                        <a role="button" href="${viewLeadURL.replace('0', row.id)}" class="text-primary d-inline-block edit-item-btn">
                            <i class="ri-eye-fill fs-16"></i>
                        </a>
                    </li>`
                {% endif %}

                {% if perms.leads.change_company %}
                actions += `<li class="list-inline-item edit" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Edit">
                        <a href="${editLeadURL.replace('0', row.id)}" class="text-primary d-inline-block edit-item-btn">
                            <i class="ri-pencil-fill fs-16"></i>
                        </a>
                    </li>`
                {% endif %}

                {% if perms.leads.delete_company %}
                actions += `<li class="list-inline-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="Remove">
                        <a class="delete-btn text-danger d-inline-block remove-item-btn" data-bs-toggle="modal" href="#deleteOrder" data-url="${deleteLeadURL.replace('0', row.id)}">
                            <i class="ri-delete-bin-5-fill fs-16"></i>
                        </a>
                    </li>`
                {% endif %}

                actions += `</ul>`
                return actions
            }
        }
        ]
    });

    $('#id_search').on( 'keyup', function () {
        table.search( this.value ).draw();
    });

    function updateAssignButtonState() {
        if (table.rows('.selected').data().length > 0) {
            $('.assign-companies').removeClass('disabled');
        } else {
            $('.assign-companies').addClass('disabled');
        }
        // Update the "select all" checkbox state based on row selection
        var allRowsSelected = table.rows({ selected: true }).count() === table.rows().count();
        $('#selectAllCheckbox').prop('checked', allRowsSelected);
    }
    const selectAllCheckbox = document.querySelector('#selectAll');
    selectAllCheckbox.addEventListener('change', function () {
        var isChecked = $(this).prop('checked');
        if (isChecked) {
            table.rows({
                page: 'current'
            }).select();
        }
        else{
            table.rows({
                page: 'current'
            }).deselect();
        }
        updateAssignButtonState();
    });

    table.on('click', 'tbody tr', function (e) {
        e.currentTarget.classList.toggle('selected');
        updateAssignButtonState(); // Update button state based on selection
    });


    $('.assign-companies').on('click', (event) => {
        var selectedIDs = table.rows('.selected').data().map(function(item) {
            return item.id;
        });
        var selectedIDsString = selectedIDs.join(',');
        $('#assignCompaniesForm').data('companies', selectedIDsString)
        $.ajax({
            type: "GET",
            url: '/api/users/?action=assigned_companies_dropdown',
            success: function(response){
                newChoices = response.results.map((row) => ({    'value': row.id,
                'label': row.first_name + ' ' + '('+row.total_assigned+')' ?? ''
            }))
                userChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                userChoices.setChoices(newChoices);
            },
            complete: function(){
                $('.btn-user-load').addClass('d-none');
            }
        })
    })
    $("#assignCompaniesForm").submit(function(e){
        e.preventDefault();
        var form = $(this);
        formData = form.serialize();
        // Get the values of Companies after submitting the form
        var companyValues = $(this).data('companies');
        // Include leadtasksJSON in the form data
        formData += '&companies=' + encodeURIComponent(companyValues);
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/leads/company/assign/`,
            data: formData,
            success: function(response)
            {
                if (response.status === 'success'){
                    Toastify({
                        text: response?.message || 0 ,
                        className: 'bg-sucess'
                    }).showToast();
                }
                $('.close-btn').trigger('click')
                selectAllCheckbox.checked = false;
            },
            error: (xhr, status, error) => {
                Toastify({
                    text: error || 'Oops something went wrong',
                    className: "bg-danger"
                }).showToast();
            }
        });
    })

    table.on('draw.dt', function () {
        updateAssignButtonState();
    });

    $(".close-btn").click(function(){
        table.ajax.reload(null, false);
    })

    $.ajax({
        type: "GET",
        url: '/api/users/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
            assignedToChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            assignedToChoices.setChoices(newChoices);
        },
        complete: function(){
            $('.btn-load').addClass('d-none');
        }
    })

    var ajax_user = null;
      userElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_user != null){
            ajax_user.abort();
            ajax_user = null
          }
          let value = event.detail.value;
          userChoices.clearChoices();
          ajax_user = $.ajax({
                type: "GET",
                url: `/api/users/?action=dropdown&search=${value}`,
                    success: function(response){
                        if(response.count > 0){
                            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
                            userChoices.clearChoices()
                            newChoices.unshift({'value': '', 'label': '---------'})
                            userChoices.setChoices(newChoices);
                        }
                    },

                })
        },
        false,
      );

      var ajax_assignedTo = null;
      assignedToElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_assignedTo != null){
            ajax_assignedTo.abort();
            ajax_assignedTo = null
          }
          let value = event.detail.value;
          assignedToChoices.clearChoices();
          ajax_assignedTo = $.ajax({
                type: "GET",
                url: `/api/users/?action=dropdown&search=${value}`,
                    success: function(response){
                        if(response.count > 0){
                            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
                            assignedToChoices.clearChoices()
                            newChoices.unshift({'value': '', 'label': '---------'})
                            assignedToChoices.setChoices(newChoices);
                        }
                    },

                })
        },
        false,
      );   

    // Handle OnChange for Assigned To Filter
    assignedToChoices.passedElement.element.addEventListener(
        'change',
        function(event) {
            if (event.detail.value === ''){
                tableParams.assigned_to = false;
            }
            else{
                tableParams.assigned_to = event.detail.value;
            }
            table.ajax.reload(null, false)
        },
        false,
    );
    // Handle OnChange for Assigned To Filter
    companiesChoices.passedElement.element.addEventListener(
        'change',
        function(event) {
            if (event.detail.value === ''){
                tableParams.assigned_to = false;
                tableParams.status = 1;
            }
            else{
                tableParams.assigned_to = ''
                tableParams.status = '';
            }
            tableParams.companies = event.detail.value;
            table.ajax.reload(null, false)
        },
        false,
    );
    statusChoices.passedElement.element.addEventListener(
        'change',
        function(event) {
            tableParams.status = event.detail.value;
            table.ajax.reload(null, false)
        },
        false,
    );

});
</script>
{% endblock extra_js %}
