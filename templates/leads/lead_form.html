{% extends "partials/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% block title %}
    Lead
{% endblock title %}
{% block extra_css %}
<link rel="stylesheet"
          href="{% static 'js/DataTables/datatables.min.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="Leads" title="Create Lead" %}
                {% endblock pagetitle %}
                <div class="modal-content">
                    <form action="" id="leadForm" data-lead="">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="leadLabel">Create Lead</h5>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-primary btn-load-lead">
                                    <span class="d-flex align-items-center">
                                        <span class="flex-grow-1 me-2">Loading Data...</span>
                                        <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                            <span class="visually-hidden">Loading Data...</span>
                                        </span>
                                    </span>
                                </button>
                                <button id="view_jobs"
                                                type="button"
                                                class="btn btn-success disabled">View Jobs
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_source" class="form-group">
                                                    <label for="id_source" class="">Source</label>
                                                    <div>
                                                        <select name="source" class="select form-control" id="id_source">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div>
                                                <div id="div_id_company" class="form-group">
                                                    <label for="id_company">Company</label>
                                                    <div>
                                                        <select name="company" class="select form-control" id="id_company">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_job_post" class="form-group">
                                                    <label for="id_job_post">Job post</label>
                                                    <div>
                                                        <select name="job_post" class="select form-control" id="id_job_post">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_person" class="form-group">
                                                    <label for="id_person" class=" requiredField">
                                                        Person<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="person"
                                                                class="selectmultiple form-control"
                                                                required
                                                                id="id_person"
                                                                multiple>
                                                            <option value="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_sales_task" class="form-group">
                                                    <label for="id_sales_task" class="">Sales task</label>
                                                    <div>
                                                        <select name="sales_task" class="select form-control" id="id_sales_task">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_sales_template" class="form-group">
                                                    <label for="id_sales_template" class="">Sales template</label>
                                                    <div>
                                                        <select name="sales_template"
                                                                class="select form-control"
                                                                id="id_sales_template">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_outbound_email" class="form-group">
                                                    <label for="id_outbound_email" class="">Outbound email</label>
                                                    <div>
                                                        <select name="outbound_email"
                                                                class="select form-control"
                                                                id="id_outbound_email">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_resume_sent" class="form-check">
                                                        <label for="id_resume_sent" class="form-check-label">Resume sent</label>
                                                        <input type="checkbox"
                                                               name="resume_sent"
                                                               class="checkboxinput form-check-input"
                                                               id="id_resume_sent">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_interested" class="form-check">
                                                        <label for="id_interested" class="form-check-label">Interested</label>
                                                        <input type="checkbox"
                                                               name="interested"
                                                               class="checkboxinput form-check-input"
                                                               id="id_interested">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_response" class="form-check">
                                                        <label for="id_response" class="form-check-label">Response</label>
                                                        <input type="checkbox"
                                                               name="response"
                                                               class="checkboxinput form-check-input"
                                                               id="id_response">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_contract_signed" class="form-check">
                                                        <label for="id_contract_signed" class="form-check-label">Contract Signed</label>
                                                        <input type="checkbox"
                                                               name="contract_signed"
                                                               class="checkboxinput form-check-input"
                                                               id="id_contract_signed">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_not_interested" class="form-check">
                                                        <label for="id_not_interested" class="form-check-label">Not Interested</label>
                                                        <input type="checkbox"
                                                               name="not_interested"
                                                               class="checkboxinput form-check-input"
                                                               id="id_not_interested">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_lead_status" class="form-group">
                                                    <label for="id_lead_status" class="">Status</label>
                                                    <div>
                                                        <select name="status" class="select form-control" id="id_lead_status">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                            <option value="1">
                                                                OPEN
                                                            </option>
                                                            <option value="2">
                                                                CLOSED
                                                            </option>
                                                            <option value="3">
                                                                EMAIL_NOT_FOUND
                                                            </option>
                                                            <option value="4">
                                                                SCHEDULED
                                                            </option>
                                                            <option value="5">
                                                                SENT
                                                            </option>
                                                            <option value="6" selected>
                                                                READY
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_contract_date" class="form-group">
                                                    <label for="id_contract_date" class="">Contract Date</label>
                                                    <div>
                                                        <input type="text"
                                                               name="contract_date"
                                                               class="dateinput form-control"
                                                               data-date-format="Y-m-d"
                                                               data-provider="flatpickr"
                                                               id="id_contract_date">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_follow_ups" class="form-group">
                                                    <label for="id_follow_ups" class="">Follow ups</label>
                                                    <div>
                                                        <input type="number"
                                                               name="follow_ups"
                                                               value="0"
                                                               class="numberinput form-control"
                                                               id="id_follow_ups">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_notes" class="form-group">
                                                    <label for="id_notes" class="">Notes</label>
                                                    <div>
                                                        <textarea name="notes" cols="40" rows="10" class="textarea form-control" id="id_notes"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>                                        
                                    </div>
                                </div>
                                <!-- end card body -->
                            </div>
                            <!-- end card -->
                        </div>
                        <!--end card-body-->
                        <div class="modal-footer">
                            <a href="{% url 'leads:lead_list' %}"
                               type="button"
                               class="btn btn-light w-sm">Cancel</a>
                            <button type="submit" class="btn btn-primary btn-create-lead">Create</button>
                            <button type="button" class="btn btn-primary btn-load d-none">
                                <span class="d-flex align-items-center">
                                    <span class="flex-grow-1 me-2">Loading...</span>
                                    <span class="spinner-border flex-shrink-0" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- container-fluid -->
            <div class="container-fluid">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-header border-0">
                                    <div class="d-flex align-items-center">
                                        <h1 class="card-title mb-0 flex-grow-1">Persons</h1>
                                    </div>
                                </div>
                                <div class="card-body border border-dashed border-end-0 border-start-0">
                                    <div class="table-responsive table-card mb-4">
                                        <table class="table align-middle table-nowrap mb-0" id="persons-table">
                                            <thead class="table-light text-muted">
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Company</th>
                                                    <th>Full Name</th>
                                                    <th>Email</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody class="list form-check-all">
                                            </tbody>
                                        </table>
                                        <!--end table-->
                                    </div>
                                </div>
                                <!--end card-body-->
                            </div>
                            <!--end card-->
                        </div>
                    </div>
                </div>
            </div>
            <!-- container-fluid -->
            <div class="container-fluid">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="card">
                            <div class="card-body">
                                <div class="card-header border-0">
                                    <div class="d-flex align-items-center">
                                        <h1 class="card-title mb-0 flex-grow-1">Leads</h1>
                                    </div>
                                </div>
                                <div class="card-body border border-dashed border-end-0 border-start-0">
                                    <div class="table-responsive table-card mb-4">
                                        <table class="table align-middle table-nowrap mb-0" id="leads-table">
                                            <thead class="table-light text-muted">
                                                <tr>
                                                    <th>Company</th>
                                                    <th>First Name</th>
                                                    <th>Last Name</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody class="list form-check-all">
                                            </tbody>
                                        </table>
                                        <!--end table-->
                                    </div>
                                </div>
                                <!--end card-body-->
                            </div>
                            <!--end card-->
                        </div>
                    </div>
                </div>
            </div>
            <!-- container-fluid -->
            <!-- Modal FORM for Create New Job Post -->
            <div id="jobPost"
                 class="modal fade"
                 tabindex="-1"
                 aria-labelledby="jobPostLabel"
                 aria-hidden="true"
                 style="display: none;">
                <div class="modal-dialog modal-md modal-dialog-centered">
                    <div class="modal-content">
                        <form action="" id="jobPostForm" data-lead="">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="jobPostLabel">Job Post</h5>
                                <div class="flex-shrink-0">
                                    <button type="button" class="btn btn-primary btn-load-JP">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">Loading Data...</span>
                                            <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading Data...</span>
                                            </span>
                                        </span>
                                    </button>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close">
                                    </button>
                                </div>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-lg-6 d-none">
                                        <div>
                                            <div id="div_id_company1" class="form-group">
                                                <label for="id_company1">
                                                    Company
                                                </label>
                                                <div>
                                                    <input name="company" class="select form-control" id="id_company1">
                                                </input>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_jb_source" class="form-group">
                                            <label for="id_jb_source" class="">
                                                Source
                                            </label>
                                            <div>
                                                <select name="source" class="select form-control" id="id_jb_source">
                                                    <option value="" selected="">
                                                        ---------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_sales_task1" class="form-group">
                                            <label for="id_sales_task1" class="">
                                                Sales task
                                            </label>
                                            <div>
                                                <select name="sales_task" class="select form-control" id="id_sales_task1">
                                                    <option value="" selected="">
                                                        ---------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_title" class="form-group">
                                            <label for="id_title" class=" requiredField">
                                                Title<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="title"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_title"
                                                       required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_description" class="form-group">
                                            <label for="id_description" class="">
                                                Description
                                            </label>
                                            <div>
                                                <textarea name="description"
                                                          cols="40"
                                                          rows="10"
                                                          class="textarea form-control"
                                                          id="id_description"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_url" class="form-group">
                                            <label for="id_url" class="">
                                                Url
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="url"
                                                       maxlength="400"
                                                       class="textinput textInput form-control"
                                                       id="id_url">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_salary" class="form-group">
                                            <label for="id_salary" class="">
                                                Salary
                                            </label>
                                            <div>
                                                <input type="number"
                                                       name="salary"
                                                       class="numberinput form-control"
                                                       id="id_salary">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_city" class="form-group">
                                            <label for="id_city" class="">
                                                City
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="city"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_city">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_state" class="form-group">
                                            <label for="id_state" class="">
                                                State
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="state"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_state">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_country" class="form-group">
                                            <label for="id_country" class=" requiredField">
                                                Country<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <select name="country"
                                                        class="select form-control"
                                                        id="id_jp_country"
                                                        required>
                                                    <option value="" selected="">
                                                        -----------------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-create-jobpost">
                                        Create
                                    </button>
                                    <button type="button" class="btn btn-primary btn-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
        <!-- Modal FORM for Create New Company -->
        <div id="companyModal"
             class="modal fade"
             tabindex="-1"
             aria-labelledby="companyLabel"
             aria-hidden="true"
             style="display: none;">
            <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                    <form action="" id="companyForm" data-lead="">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="companyLabel">
                                Company
                            </h5>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-primary btn-load-company">
                                    <span class="d-flex align-items-center">
                                        <span class="flex-grow-1 me-2">
                                            Loading Data...
                                        </span>
                                        <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                            <span class="visually-hidden">Loading Data...</span>
                                        </span>
                                    </span>
                                </button>
                                <button type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close">
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_industry" class="form-group">
                                            <label for="id_com_industry" class="">
                                                Industry
                                            </label>
                                            <div>
                                                <select name="industry" class="select form-control" id="id_com_industry">
                                                    <option value="" selected="">
                                                        ---------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_name" class="form-group">
                                            <label for="id_name" class="" requiredField>
                                                Name<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="name"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       required
                                                       id="id_name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_domain" class="form-group">
                                            <label for="id_domain" class="" requiredField>
                                                Domain<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="domain"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       required
                                                       id="id_domain">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_linkedin" class="form-group">
                                            <label for="id_linkedin" class="" requiredField>
                                                Linkedin<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="linkedin"
                                                       maxlength="1000"
                                                       class="textinput textInput form-control"
                                                       required
                                                       id="id_linkedin">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_country" class="form-group">
                                            <label for="id_country" class=" requiredField">
                                                Country<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <select name="country"
                                                        class="select form-control"
                                                        id="id_company_country"
                                                        required>
                                                    <option value="" selected="">
                                                        -----------------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary btn-create-company">
                                Create
                            </button>
                            <button type="button" class="btn btn-primary btn-load d-none">
                                <span class="d-flex align-items-center">
                                    <span class="flex-grow-1 me-2">
                                        Loading...
                                    </span>
                                    <span class="spinner-border flex-shrink-0" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
        <!-- Modal FORM for Create New Person -->
        <div id="personModal"
             class="modal fade"
             tabindex="-1"
             aria-labelledby="personLabel"
             aria-hidden="true"
             style="display: none;">
            <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                    <form action="" id="personForm">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="personLabel">
                                Person
                            </h5>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-primary btn-load-person">
                                    <span class="d-flex align-items-center">
                                        <span class="flex-grow-1 me-2">
                                            Loading DataBase...
                                        </span>
                                        <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                            <span class="visually-hidden">Loading DataBase...</span>
                                        </span>
                                    </span>
                                </button>
                                <button type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close">
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <input type="hidden" name="company" id="id_person_company" />
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_first_name" class="form-group">
                                            <label for="id_first_name" class="">
                                                First name
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="first_name"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_first_name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_last_name" class="form-group">
                                            <label for="id_last_name" class="">
                                                Last name
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="last_name"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_last_name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_designation" class="form-group">
                                            <label for="id_designation" class="">
                                                Designation
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="designation"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_designation">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_linkedin" class="form-group">
                                            <label for="id_linkedin" class="">
                                                Linkedin
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="linkedin"
                                                       maxlength="1000"
                                                       class="textinput textInput form-control"
                                                       id="id_linkedin">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_email" class="form-group">
                                            <label for="id_email" class="">
                                                Email
                                            </label>
                                            <div>
                                                <input type="email"
                                                       name="email"
                                                       maxlength="254"
                                                       class="emailinput form-control"
                                                       id="id_email">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_email2" class="form-group">
                                            <label for="id_email2" class="">
                                                Email2
                                            </label>
                                            <div>
                                                <input type="email"
                                                       name="email2"
                                                       maxlength="254"
                                                       class="emailinput form-control"
                                                       id="id_email2">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_email3" class="form-group">
                                            <label for="id_email3" class="">
                                                Email3
                                            </label>
                                            <div>
                                                <input type="email"
                                                       name="email3"
                                                       maxlength="254"
                                                       class="emailinput form-control"
                                                       id="id_email3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_city" class="form-group">
                                            <label for="id_city" class="">
                                                City
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="city"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_city">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_state" class="form-group">
                                            <label for="id_state" class="">
                                                State
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="state"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_state">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_country" class="form-group">
                                            <label for="id_country" class=" requiredField">
                                                Country<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <select name="country"
                                                        class="select form-control"
                                                        id="id_person_country"
                                                        required>
                                                    <option value="" selected="">
                                                        ---------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_person_status" class="form-group">
                                            <label for="id_person_status" class=" requiredField">
                                                Status<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <select name="status"
                                                        class="select form-control"
                                                        id="id_person_status"
                                                        required>
                                                    <option value="1" selected>
                                                        New
                                                    </option>
                                                    <option value="2">
                                                        Email Not Found
                                                    </option>
                                                    <option value="3">
                                                        Contacted
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary btn-create-person">
                                Create
                            </button>
                            <button type="button" class="btn btn-primary btn-load d-none">
                                <span class="d-flex align-items-center">
                                    <span class="flex-grow-1 me-2">
                                        Loading...
                                    </span>
                                    <span class="spinner-border flex-shrink-0" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
    </div>
    <!-- End Page-content -->
    {% block footer %}
        {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
<!-- end main content-->
{% endblock content %}
{% block extra_content %}
{% endblock extra_content %}
{% block extra_js %}

    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <script src="{% static 'js/DataTables/datatables.min.js' %}"></script>
    <script src="{% static 'js/moment-2.29.2.min.js' %}"></script>
    <link href="https://cdn.datatables.net/select/1.7.0/css/select.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<script>
    window.onbeforeunload = function() {
        preSourceValue = $('#id_source').val();
        preJobPostValue = $('#id_job_post').val();
        preCompanyValue = $('#id_company').val();
        preSalesTaskValue = $('#id_sales_task').val();
        preSalesTemplateValue = $('#id_sales_template').val();
        preOutboundEmailValue = $('#id_outbound_email').val();
        localStorage.setItem("source", preSourceValue);
        localStorage.setItem("job_post",preJobPostValue);
        localStorage.setItem("company", preCompanyValue);
        localStorage.setItem("sales_task", preSalesTaskValue);
        localStorage.setItem("sales_template", preSalesTemplateValue);
        localStorage.setItem("outbound_email", preOutboundEmailValue);
    }

$(document).ready(function(){

    const leadSourceChoices = new Choices(document.querySelector('#id_source'), {searchResultLimit: 50})
    const leadStatusChoices = new Choices(document.querySelector('#id_lead_status'),{shouldSort: false})
    const jobPostChoices = new Choices(document.querySelector('#id_job_post'), {searchResultLimit: 50})
    const leadSalesTaskChoices = new Choices(document.querySelector('#id_sales_task'), {searchResultLimit: 50})
    const SalesTemplateChoices = new Choices(document.querySelector('#id_sales_template'), {searchResultLimit: 50})
    const outboundEmailChoices = new Choices(document.querySelector('#id_outbound_email'), {searchResultLimit: 50})
    const companyChoices = new Choices(document.querySelector('#id_company'), {searchResultLimit: 50})
    const personChoices = new Choices(document.querySelector('#id_person'), {searchResultLimit: 50})
    const salesTaskChoices = new Choices(document.querySelector('#id_sales_task1'), {searchResultLimit: 50})
    const sourceChoices = new Choices(document.querySelector('#id_jb_source'), {searchResultLimit: 50})
    const industryChoices = new Choices(document.querySelector('#id_com_industry'), {searchResultLimit: 50})
    const jobPostCountryChoices = new Choices(document.querySelector('#id_jp_country'), {searchResultLimit: 50, shouldSort: false})
    const companyCountryChoices = new Choices(document.querySelector('#id_company_country'), {searchResultLimit: 50, shouldSort: false})
    const personCountryChoices = new Choices(document.querySelector('#id_person_country'), {searchResultLimit: 50, shouldSort: false})
    const LeadCompanyelement = document.getElementById('id_company');
    const LeadJobpostelement = document.getElementById('id_job_post');
    const industryElement = document.getElementById('id_com_industry');
    const JobpostSaleTaskelement = document.getElementById('id_sales_task1');
    const outboundemailelement = document.getElementById('id_outbound_email');
    const salestaskelement = document.getElementById('id_sales_task');

    var leadProgress=0;
    var jobpostProgress=0;
    var companyProgress=0;

    $.ajax({
        type: "GET",
        url: '/api/source/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            leadSourceChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            leadSourceChoices.setChoices(newChoices);
            source_id = `{{source_id}}`
            if(source_id){
                leadSourceChoices.setChoiceByValue({{source_id}});
            }
        },
        complete: function(){
            leadProgress+=1;
                if(leadProgress==5){
                    $('.btn-load-lead').addClass('d-none');
                }
            var source = localStorage.getItem("source");
            if (source == null || source == ''){
                return
            }else{
                try{
                    sourceValue = parseInt(source);
                    leadSourceChoices.setChoiceByValue(sourceValue);
                } catch (err) {
                    console.error(err);
                }
            }
            }
    })

    $.ajax({
        type: "GET",
        url: '/api/company/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            companyChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            companyChoices.setChoices(newChoices);
            company_id = `{{company_id}}`
            if(company_id){
                $.ajax({
                    type: "GET",
                    url: `/api/company/?action=dropdown&id=${company_id}`,
                    success: function(response){
                        newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                        companyChoices.clearChoices()
                        newChoices.unshift({'value': '', 'label': '---------'})
                        companyChoices.setChoices(newChoices);
                        companyChoices.setChoiceByValue({{company_id}});
                    },
                })
            }
        },
        complete: function(){
            leadProgress +=1;
            if(leadProgress==5){
                $('.btn-load-lead').addClass('d-none');
            }
            let company = localStorage.getItem("company");
            if (company == null || company == ''){
                return
            }
            else{
                try{
                    let companyValue = parseInt(company);
                    $.ajax({
                        type: "GET",
                        url: `/api/company/?action=dropdown&id=${companyValue}`,
                        success: function(response){
                            value = response.results[0]
                        },
                        complete: function(){
                            newChoice = [{ value: value.id, label: value.name }]
                            newChoice.unshift({'value': '', 'label': '---------'})
                            companyChoices.setChoices(newChoice)
                            companyChoices.setChoiceByValue(value.id);
                            if(companyChoices.getValue(true)){
                                updateViewJobsButton(value.id);
                                loadPersonsForCompany(value.id);
                                loadJobpostsForCompany(value.id);
                                $('button.personModal').removeClass('disabled')
                                $('button.jobpostModal').removeClass('disabled');
                            }else{
                                updateViewJobsButton(value.id);
                                $('button.personModal').addClass('disabled')
                                $('button.jobpostModal').addClass('disabled');
                            }
                        }
                    })
                } catch (err) {
                console.error(err);
                }
            }

        }
    })

    $.ajax({
        type: "GET",
        url: '/api/salestask/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            leadSalesTaskChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            leadSalesTaskChoices.setChoices(newChoices);
            sales_task_id = `{{sales_task_id}}`
            if(sales_task_id){
                $.ajax({
                    type: "GET",
                    url: `/api/salestask/?action=dropdownid=${sales_task_id}`,
                    success: function(response){
                        newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                        leadSalesTaskChoices.clearChoices()
                        newChoices.unshift({'value': '', 'label': '---------'})
                        leadSalesTaskChoices.setChoices(newChoices);
                        leadSalesTaskChoices.setChoiceByValue({{sales_task_id}});
                    },
                })
            }
        },
        complete: function(){
            leadProgress +=1;
            if(leadProgress==5){
                $('.btn-load-lead').addClass('d-none');
            }
            var sales_task = localStorage.getItem("sales_task");
            if (sales_task == null || sales_task == ''){
                return
            }
            else{
                try{
                    sales_taskValue = parseInt(sales_task);
                    $.ajax({
                        type: "GET",
                        url: `/api/salestask/?action=dropdown&search=${sales_taskValue}`,
                        success: function(response){
                            value = response.results[0]
                        },
                        complete: function(){
                            leadSalesTaskChoices.setChoices([{ value: value.id, label: value.name }])
                            leadSalesTaskChoices.setChoiceByValue(value.id);
                        }
                    })
                } catch (err) {
                console.error(err);
                }
            }
        }
    })

    $.ajax({
        type: "GET",
        url: '/api/salestemplate/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            SalesTemplateChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            SalesTemplateChoices.setChoices(newChoices);
            SalesTemplateChoices.setChoiceByValue(1);
        },
        complete: function(){
            leadProgress +=1;
            if(leadProgress==5){
                $('.btn-load-lead').addClass('d-none');
            }
            var sales_template = localStorage.getItem("sales_template");
            if (sales_template == null || sales_template == ''){
                return
            }
            else{
                try{
                    sales_templateValue = parseInt(sales_template);
                    $.ajax({
                        type: "GET",
                        url: `/api/salestemplate/?action=dropdown&search=${sales_templateValue}`,
                        success: function(response){
                            value = response.results[0]
                        },
                        complete: function(){
                            SalesTemplateChoices.setChoices([{ value: value.id, label: value.name }])
                            SalesTemplateChoices.setChoiceByValue(value.id);
                        }
                    })
                } catch (err) {
                console.error(err);
                }
            }
        }
    })

    $.ajax({
        type: "GET",
        url: '/api/outboundemail/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
            outboundEmailChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            outboundEmailChoices.setChoices(newChoices);
            outboundEmailChoices.setChoiceByValue(1);
        },
        complete: function(){
            leadProgress +=1;
            if(leadProgress==5){
                $('.btn-load-lead').addClass('d-none');
            }
            var outbound_email = localStorage.getItem("outbound_email");
            if (outbound_email == null || outbound_email == ''){
                return
            }
            else{
                try{
                    outbound_emailValue = parseInt(outbound_email);
                    $.ajax({
                        type: "GET",
                        url: `/api/outboundemail/?action=dropdown&search=${outbound_emailValue}`,
                        success: function(response){
                            value = response.results[0]
                        },
                        complete: function(){
                            outboundEmailChoices.setChoices([{ value: value.id, label: value.email }])
                            outboundEmailChoices.setChoiceByValue(value.id);
                        }
                    })
                } catch (err) {
                console.error(err);
                }
            }
        }
    })
    
    var personsTable = $('#persons-table').DataTable({
        "dom": 'lrtip',
        "columnDefs":
            [
            {
                // Hide the ID column
                targets: 0,
                visible: false,
                searchable: false,
            },
            {
                targets: 2,
                defaultContent: '-',
            },
            {
                targets: 3,
                defaultContent: '-',
            },
            {
                targets: 4,
                defaultContent: '-',
            },
            ]
    });
    
    var leadsTable = $('#leads-table').DataTable({
        "dom": 'lrtip',
        "columnDefs":
            [
            {
                targets: 0,
                defaultContent: '-',
            },
            {
                targets: 1,
                defaultContent: '-',
            },
            {
                targets: 2,
                defaultContent: '-',
            },
            {
                targets: 3,
                defaultContent: '-',
            },
            ]
        });

    $('#persons-table tbody').on('click', '.select-checkbox', function () {
        var tr = $(this).closest('tr');
        var row = personsTable.row(tr);
    
        // Toggle the selection state of the row
        row.select(!row.select().any());
    
        // Update the checkbox state based on row selection
        $(this).prop('checked', row.select().any());
        
        // Deselect the row if the checkbox is unchecked
        if (!$(this).prop('checked')) {
            row.deselect();
        }
    });

    personsTable.on('click', 'tbody tr', function (e) {
        $(this).toggleClass('selected');
        
        personChoices.clearStore();
        
        var selectedRows = personsTable.rows('.selected').data();
        var selectedIdsAndNames = Array.from(selectedRows).map(function (row) {
            return {
                id: row[0],
                first_name: row[2]
            };
        });
        
        var selectedChoices = selectedIdsAndNames.map(function (person) {
            return { value: person.id, label: person.first_name, selected: true };
        });
        
        // Set the new choices
        personChoices.setChoices(selectedChoices, 'value', 'label', true);
    });


    const loadPersonsForCompany = (company) => {
        personChoices.clearChoices();
        // Load the persons dropdown for give company
        let companyValue = companyChoices.getValue();
        let s_companyValue = companyValue['label'].search("Blocked Company")
        if(s_companyValue != -1){
            Toastify({
                text: "Error: Selected Company is Blocked!",
                className: 'bg-danger'
              }).showToast();
        }
        else{
            $.ajax({
                type: "GET",
                url: '/api/person/',
                data: {'company':company},
                success: function(response){
                    personsTable.clear().draw();
                    //newChoices = response.results.map((row) => ({'value': row.id, 'label': row.first_name !== undefined && row.first_name !== null && row.first_name !== '' ? row.first_name : 'No Name'}))
                    //personChoices.clearChoices()
                    //newChoices.unshift({'value': '', 'label': '---------'})
                    //personChoices.setChoices(newChoices);
                    response.results.forEach(function (person) {
                        personsTable.row.add([
                            person.id,
                            person.company_name,
                            person.first_name,
                            person.email,
                            person.status,
                        ]).draw();
                    });
                    leadsTable.clear().draw()
                    $.ajax({
                        url: "/api/lead/",
                        type: "GET",
                        data: {'company':company},
                        success: function (response) {
                            response.results.forEach(function (lead) {
                                leadsTable.row.add([
                                    lead.company.name,
                                    lead.person.first_name,
                                    lead.person.last_name,
                                    lead.status,
                                ]).draw();
                            });
                        },
                        error: function (error) {
                            console.error("Error fetching data from the server:", error);
                        }
                    });
                }
            })
        }
    }

    const loadJobpostsForCompany = (company) => {
        // Load the JobPosts dropdown for given company
        $.ajax({
            type: "GET",
            url: `/api/jobpost/?action=dropdown&company=${company}`,
            success: function(response){
                newChoices = response.results.map((row) => ({'value': row.id, 'label': row.title !== undefined && row.title !== null && row.title !== '' ? row.title : 'No Title'}))
                jobPostChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                jobPostChoices.setChoices(newChoices);
            }
        })
    }

    companyChoices.passedElement.element.addEventListener(
      'change',
      function(event) {
        updateViewJobsButton(event.detail.value);
        if(companyChoices.getValue(true)){
            $.ajax({
                type: "GET",
                url: `/api/validatelead/?search=${event.detail.value}`,
                success: function(response){
                    if(response.count > 0){
                        Toastify({
                            text: "Lead already created for the selected company!",
                            className: 'bg-danger'
                        }).showToast();
                        
                    }
                    loadPersonsForCompany(event.detail.value);
                    loadJobpostsForCompany(event.detail.value);
                    $('button.personModal').removeClass('disabled');
                    $('button.jobpostModal').removeClass('disabled');
                }
            })
        }
        else{
            personChoices.clearChoices();
            jobPostChoices.clearChoices();
            $('button.personModal').addClass('disabled');
            $('button.jobpostModal').addClass('disabled');
        }
        },
        false,
    );

    var ajax_LeadCompany = null
    var ajax_LeadBlockedCompany = null
    LeadCompanyelement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_LeadCompany != null && ajax_LeadBlockedCompany != null){
            ajax_LeadCompany.abort();
            ajax_LeadBlockedCompany.abort();
            ajax_LeadCompany = null
            ajax_LeadBlockedCompany = null
          }
          let input = event.detail.value
          companyChoices.clearChoices();
          ajax_LeadCompany = $.ajax({
                type: "GET",
                url: `/api/company/?action=dropdown&search=${input}`,
                success: function(response){
                    if(response.count > 0){
                        const new_choices = []
                        response.results.forEach((company)=>{
                            if(company.name){
                                new_choices.push({ value: company.id, label: company.name })
                            }
                            else{
                                console.log("Invalid Data on Company ID: ", company.id)
                            }
                        })

                        companyChoices.setChoices(new_choices, 'value', 'label', false)
                    }
                }
            })
            ajax_LeadBlockedCompany = $.ajax({
                type: "GET",
                url: `/api/blockedcompany/?action=dropdown&search=${input}`,
                success: function(response){
                    if(response.count > 0){
                        const new_choices = []
                        response.results.forEach((blockedCompany)=>{
                            if(blockedCompany.name){
                                new_choices.push({ value: blockedCompany.id, label: blockedCompany.name + ' - Blocked Company' })
                            }
                            else{
                                console.log("Invalid Data on Blocked Company ID: ", blockedCompany.id)
                            }
                        })

                        companyChoices.setChoices(new_choices, 'value', 'label', false)
                    }
                }
            })
        },
        false,
      );
      var ajax_industry = null;
    industryElement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_industry != null){
            ajax_industry.abort();
            ajax_industry = null
          }
          let input = event.detail.value
          industryChoices.clearChoices();
          ajax_industry = $.ajax({
            type: "GET",
            url: `/api/industry/?action=dropdown&search=${input}`,
            success: function(response){
                newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                industryChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                industryChoices.setChoices(newChoices);
            }
        })
        },
        false,
      );

      var ajax_salesTask = null
       JobpostSaleTaskelement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_salesTask != null){
            ajax_salesTask.abort();
            ajax_salesTask = null
          }
          let input = event.detail.value
          salesTaskChoices.clearChoices();
          ajax_salesTask = $.ajax({
            type: "GET",
            url: `/api/salestask/?action=dropdown&search=${input}`,
            success: function(response){
                newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                salesTaskChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                salesTaskChoices.setChoices(newChoices);
            },

        })
        },
        false,
      );

      var ajax_outboundEmail = null;
      outboundemailelement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_outboundEmail != null){
            ajax_outboundEmail.abort();
            ajax_outboundEmail = null
          }
          let input = event.detail.value
          outboundEmailChoices.clearChoices();
          ajax_outboundEmail = $.ajax({
                type: "GET",
                url: `/api/outboundemail/?action=dropdown&search=${input}`,
                success: function(response){
                    newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
                    outboundEmailChoices.clearChoices()
                    newChoices.unshift({'value': '', 'label': '---------'})
                    outboundEmailChoices.setChoices(newChoices);
                },
            })
        },
        false,
      );

      var ajax_leadSalesTask = null;
       salestaskelement.addEventListener(
        'search',
        function(event) {
          // do something creative here...
          if(ajax_leadSalesTask != null){
            ajax_leadSalesTask.abort();
            ajax_leadSalesTask = null
          }
          let input = event.detail.value
          leadSalesTaskChoices.clearChoices();
          ajax_leadSalesTask = $.ajax({
                type: "GET",
                url: `/api/salestask/?action=dropdown&search=${input}`,
                    success: function(response){
                        newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                        leadSalesTaskChoices.clearChoices()
                        newChoices.unshift({'value': '', 'label': '---------'})
                        leadSalesTaskChoices.setChoices(newChoices);
                    },

                })
        },
        false,
      );


    $('#div_id_job_post > div').addClass('d-flex').append('<button class="btn btn-success disabled flex-shrink-0 ms-1 jobpostModal" type="button" style="height:38px" data-bs-toggle="modal" data-bs-target="#jobPost">+</button>')
    $('#div_id_job_post > div > div').addClass('flex-grow-1')

    $('#div_id_company > div').addClass('d-flex').append('<button class="btn btn-success flex-shrink-0 ms-1 companyModal" type="button" style="height:38px" data-bs-toggle="modal" data-bs-target="#companyModal">+</button>')
    $('#div_id_company > div > div').addClass('flex-grow-1')

    $('#div_id_person > div').addClass('d-flex').append('<button class="btn btn-success disabled flex-shrink-0 ms-1 personModal" type="button" style="height:38px" data-bs-toggle="modal" data-bs-target="#personModal">+</button>')    
    $('#div_id_person > div > div').addClass('flex-grow-1')

    // Create Jobpost Button Ajax
    $('button.jobpostModal').click(function(){
        $('#id_company1').val(companyChoices.getValue('id'))
        $.ajax({
            type: "GET",
            url: '/api/salestask/?action=dropdown',
            success: function(response){
                newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                salesTaskChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                salesTaskChoices.setChoices(newChoices);
            },
            complete: function(){
                jobpostProgress+=1;
                if(jobpostProgress==3){
                    $('.btn-load-JP').addClass('d-none');
                }
            }
        })

        $.ajax({
            type: "GET",
            url: '/api/source/?action=dropdown',
            data: {},
            success: function(response){
                newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                sourceChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                sourceChoices.setChoices(newChoices);
            },
            complete: function(){
                jobpostProgress+=1;
                if(jobpostProgress==3){
                    $('.btn-load-JP').addClass('d-none');
                }
                var source = localStorage.getItem("source");
            }
        })






        $.ajax({
            type: "GET",
            url: '/leads/countrieslist/',
            data: {},
            success: function(response){
                newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                jobPostCountryChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                jobPostCountryChoices.setChoices(newChoices);
            },
            complete: function(){
                jobpostProgress+=1;
                if(jobpostProgress==3){
                    $('.btn-load-JP').addClass('d-none');
                }
            }
        })
    })

    // Create Company Button Ajax
    $('button.companyModal').click(function(){
        $.ajax({
            type: "GET",
            url: '/api/industry/?action=dropdown',
            success: function(response){
                newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
                industryChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                industryChoices.setChoices(newChoices);
            },
            complete: function(){
                companyProgress+=1;
                if(companyProgress==2){
                    $('.btn-load-company').addClass('d-none');
                }
            }
        })

        $.ajax({
            type: "GET",
            url: '/leads/countrieslist/',
            data: {},
            success: function(response){
                newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                companyCountryChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                companyCountryChoices.setChoices(newChoices);
            },
            complete: function(){
                companyProgress+=1;
                if(companyProgress==2){
                    $('.btn-load-company').addClass('d-none');
                }
            }
        })
    })

    // Create Person Button Ajax
    $('button.personModal').click(function(){
        $.ajax({
            type: "GET",
            url: '/leads/countrieslist/',
            data: {},
            success: function(response){
                newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                personCountryChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                personCountryChoices.setChoices(newChoices);
            },
            complete: function(){
                $('.btn-load-person').addClass('d-none');
            }
        })
    })

    // Create Lead
    $('#leadForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('.btn-load').removeClass('d-none');
        $('.btn-create-lead').addClass('d-none');
        var form = $(this);
        var resume_sent_checkbox = document.getElementById('id_resume_sent');
        var interested_checkbox = document.getElementById('id_interested');
        var response_checkbox = document.getElementById('id_response');
        var contract_signed_checkbox = document.getElementById('id_contract_signed');
        var not_interested_checkbox = document.getElementById('id_not_interested');
        var resume_sent_isChecked = resume_sent_checkbox.checked;
        var interested_isChecked = interested_checkbox.checked;
        var response_isChecked = response_checkbox.checked;
        var contract_signed_isChecked = contract_signed_checkbox.checked;
        var not_interested_isChecked = not_interested_checkbox.checked;
        if (resume_sent_checkbox){
            form.find('input[name="resume_sent"]').val(1);
        }
        else{
            form.find('input[name="resume_sent"]').val(0);
        }
        if (interested_isChecked){
            form.find('input[name="interested"]').val(1);
        }
        else{
            form.find('input[name="interested"]').val(0);
        }
        if (response_isChecked){
            form.find('input[name="response"]').val(1);
        }
        else{
            form.find('input[name="response"]').val(0);
        }
        if (contract_signed_isChecked){
            form.find('input[name="contract_signed"]').val(1);
        }
        else{
            form.find('input[name="contract_signed"]').val(0);
        }
        if (not_interested_isChecked){
            form.find('input[name="not_interested"]').val(1);
        }
        else{
            form.find('input[name="not_interested"]').val(0);
        }
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/lead/`,
            data: form.serialize(), // serializes the form's elements.
            success: function(response)
            {
                    // Show the success message
                Toastify({
                    text: "The Leads has been added successfully",
                  }).showToast();
                  $('.btn-load').addClass('d-none');
                  $('.btn-create-lead').removeClass('d-none');
                localStorage.clear();
                window.location = "/leads/list/"
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `${field}: ${err[field]}`,
                            className: 'bg-danger',
                            style: {
                              'text-transform': "capitalize",
                            },
                        }).showToast();
                    })

                } else {
                    Toastify({
                      text: "Oops something went wrong.",
                      className: 'bg-danger'
                    }).showToast();
                }
                $('.btn-load').addClass('d-none');
                $('.btn-create-lead').removeClass('d-none');
            }
        });
    })

    // Create New Job Post
    $('#jobPostForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('.btn-load').removeClass('d-none');
        $('.btn-create-jobpost').addClass('d-none');
        var form = $(this);
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/jobpost/`,
            data: form.serialize(), // serializes the form's elements.
            success: function(response)
            {

                jobPostChoices.setChoices(
                    [
                        {value: response.id, label: response.title, selected: true}
                    ]
                )
                Toastify({
                    text: "Job Post has been added successfully",
                }).showToast();
                $('.btn-load').addClass('d-none');
                $('.btn-create-jobpost').removeClass('d-none');
                // show response.
                form.trigger("reset");
                $('.close-btn').trigger('click')
            },
            error: (xhr, status, error) => {
                var err = eval("(" + xhr.responseText + ")");
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `Error: ${err[field]}`,
                            className: 'bg-danger',
                        }).showToast();
                    })
                    
                } else {
                    Toastify({
                        text: "Oops something went wrong.",
                        className: 'bg-danger'
                    }).showToast();
                }
                $('.btn-load').addClass('d-none');
                $('.btn-create-jobpost').removeClass('d-none');
            }
        });
    })

    // Create New Company
$('#companyForm').submit(function(e){
    e.preventDefault(); // avoid to execute the actual submit of the form.
    $('.btn-load').removeClass('d-none');
    $('.btn-create-company').addClass('d-none');
    var form = $(this);
    let inputName = this.name.value
    let inputdomain = this.domain.value
    $.ajax({
        type: "POST",
        headers: { "X-CSRFToken": '{{csrf_token}}' },
        url: `/api/company/?action=create`,
        data: form.serialize(), // serializes the form's elements.
        success: (response) => {
            // Show the success message
            Toastify({
              text: "The company has been added successfully",
            }).showToast();
            $('.btn-load').addClass('d-none');
            $('.btn-create-company').removeClass('d-none');
            // show response.
            companyChoices.setChoices(
                [
                    {value: response.id, label: response.name, selected: true}
                ]
            )
            personChoices.clearChoices()
            $('button.personModal').removeClass('disabled')
            $('button.jobpostModal').removeClass('disabled');
            form.trigger("reset");
            $('.close-btn').trigger('click')
        },
        error: (xhr, status, error) => {
            // Handle Ajax Error for API
            var err = eval("(" + xhr.responseText + ")");
            if(Object.keys(err).length){
                Object.keys(err).forEach((field) => {
                    Toastify({
                        text: `Error: ${err[field]}`,
                        className: 'bg-danger',
                    }).showToast();
                })
                
            } else {
                Toastify({
                    text: "Oops something went wrong.",
                    className: 'bg-danger'
                }).showToast();
            }
            $('.btn-load').addClass('d-none');
            $('.btn-create-company').removeClass('d-none');
            
        },
    });
})

    // Reset the person form on close the modal
    const personFormModalEl = document.getElementById('personModal')
    personFormModalEl.addEventListener('hidden.bs.modal', event => {
        $('#personForm').trigger('reset')
        $('.btn-load').addClass('d-none');
        $('.btn-create-person').removeClass('d-none');
    })

    // Create New Person
    $('#personForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('#id_person_company').val(companyChoices.getValue('id'))
        $('#id_company1').val(companyChoices.getValue('id'))
        $('.btn-load').removeClass('d-none');
        $('.btn-create-person').addClass('d-none');
        var form = $(e.target);
        let companyValue = companyChoices.getValue();
        let s_companyValue = companyValue['label'].search("Blocked Company");
        if(s_companyValue != -1){
            Toastify({
                text: "Error: Selected Company is Blocked!",
                className: 'bg-danger'
              }).showToast();
        }
        else{
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/person/`,
            data: form.serialize(), // serializes the form's elements.
            success: (response) => {
                // show response.
                /*personChoices.setChoices(
                    [
                        {value: response.id, label: response.first_name, selected: true}
                    ]
                )*/
                form.trigger("reset");
                $('.close-btn').trigger('click')
                Toastify({
                    text: "The Person has been added successfully",
                }).showToast();
                loadPersonsForCompany(companyValue.value)
            },
            complete: function(){
                $('.btn-load').addClass('d-none');
                $('.btn-create-person').removeClass('d-none');
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.error(err)
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `${field}: ${err[field]}`,
                            className: 'bg-danger',
                            style: {
                              'text-transform': "capitalize",
                            },
                        }).showToast();
                    })

                } else {
                    Toastify({
                      text: "Oops something went wrong.",
                      className: 'bg-danger'
                    }).showToast();
                }


                $('.btn-load').addClass('d-none');
                $('.btn-create-person').removeClass('d-none');
            }
        });
    }
    })

    $('button.use-company').click((e) => {
        // Button placed in the existing company detail in Create company pop up. mark the company selected
        // if user choose to use this company
        console.log($('button.use-company'))
        console.log($('button.use-company').attr('data-id'))
        let companyId = $('button.use-company').attr('data-id')

        // Mark the company selected in dropdown and load persons for that company
        companyChoices.setChoiceByValue(companyId)
        loadPersonsForCompany(companyId)

        // Reset the company form and close modal
        $('#companyForm').trigger("reset");
        $('#companyForm .close-btn').trigger('click')
    })


    const companyModalEl = document.getElementById('companyModal')
    companyModalEl.addEventListener('hidden.bs.modal', event => {
        // do something...
        $('.company-detail').addClass('d-none');
    })

    function updateViewJobsButton(company){
        if(companyChoices.getValue(true)){
            $.ajax({
                type: "GET",
                url: `/api/company/?action=dropdown&id=${company}`,
                success: function(response){
                    if(response.count > 0){
                        linkedin = response.results[0].linkedin
                        if(linkedin){
                            var companyNameRegex = /\/company\/([^\/?]+)/;
                            var match = linkedin.match(companyNameRegex);
                            if (match) {
                                var companyName = match[1];
                                var modifiedUrl = linkedin.replace(companyNameRegex, "/company/" + companyName + "/jobs/");
                                modifiedUrl = modifiedUrl.replace(/\/jobs\/.*/, "/jobs/");
                                $('#view_jobs').attr('href', modifiedUrl)
                                $('#view_jobs').removeClass('disabled')
                            }
                        }
                    }
                }
            })
        }
        else{
            $('#view_jobs').addClass('disabled')
        }
    }

    $('#view_jobs').click(function(){
        link = $('#view_jobs').attr('href')
        window.open(link, '_blank')
    });
})
</script>
{% endblock extra_js %}
