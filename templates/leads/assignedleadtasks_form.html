{% extends "partials/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% block title %}
    Lead
{% endblock title %}
{% block extra_css %}
{% endblock extra_css %}
{% block content %}
    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                {% block pagetitle %}
                    {% include "partials/page-title.html" with pagetitle="Leads" title="Create Lead" %}
                {% endblock pagetitle %}
                <div class="modal-content">
                    <form action="" id="leadForm" data-lead="">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="leadLabel">Create Lead</h5>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-primary btn-load-lead">
                                    <span class="d-flex align-items-center">
                                        <span class="flex-grow-1 me-2">Loading Data...</span>
                                        <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                            <span class="visually-hidden">Loading Data...</span>
                                        </span>
                                    </span>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_source" class="form-group">
                                                    <label for="id_source" class="">Source</label>
                                                    <div>
                                                        <select name="source" class="select form-control" id="id_source">
                                                            <option value="{{source.id}}" selected="">
                                                                {{source.name}}
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div>
                                                <div id="div_id_company" class="form-group">
                                                    <label for="id_company">Company</label>
                                                    <div>
                                                        <select name="company" class="select form-control" id="id_company">
                                                            <option value="{{company.id}}" selected="">
                                                                {{company.name}}
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_job_post" class="form-group">
                                                    <label for="id_job_post">Job post</label>
                                                    <div>
                                                        <select name="job_post" class="select form-control" id="id_job_post">
                                                            <option value="{{job_post.id}}" selected id="JobPostOption">
                                                                {{job_post.title}}
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_person" class="form-group">
                                                    <label for="id_person" class=" requiredField">
                                                        Person<span class="asteriskField">*</span>
                                                    </label>
                                                    <div>
                                                        <select name="person"
                                                                class="selectmultiple form-control"
                                                                required
                                                                id="id_person"
                                                                multiple>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_sales_task" class="form-group">
                                                    <label for="id_sales_task" class="">Sales task</label>
                                                    <div>
                                                        <select name="sales_task" class="select form-control" id="id_sales_task">
                                                            <option value="{{sales_task.id}}" selected>
                                                                {{sales_task.name}}
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_sales_template" class="form-group">
                                                    <label for="id_sales_template" class="">Sales template</label>
                                                    <div>
                                                        <select name="sales_template"
                                                                class="select form-control"
                                                                id="id_sales_template">
                                                            <option value="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_outbound_email" class="form-group">
                                                    <label for="id_outbound_email" class="">Outbound email</label>
                                                    <div>
                                                        <select name="outbound_email"
                                                                class="select form-control"
                                                                id="id_outbound_email">
                                                            <option value="">
                                                                ---------
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_resume_sent" class="form-check">
                                                        <label for="id_resume_sent" class="form-check-label">Resume sent</label>
                                                        <input type="checkbox"
                                                               name="resume_sent"
                                                               class="checkboxinput form-check-input"
                                                               id="id_resume_sent">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_interested" class="form-check">
                                                        <label for="id_interested" class="form-check-label">Interested</label>
                                                        <input type="checkbox"
                                                               name="interested"
                                                               class="checkboxinput form-check-input"
                                                               id="id_interested">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_response" class="form-check">
                                                        <label for="id_response" class="form-check-label">Response</label>
                                                        <input type="checkbox"
                                                               name="response"
                                                               class="checkboxinput form-check-input"
                                                               id="id_response">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3">
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_contract_signed" class="form-check">
                                                        <label for="id_contract_signed" class="form-check-label">Contract Signed</label>
                                                        <input type="checkbox"
                                                               name="contract_signed"
                                                               class="checkboxinput form-check-input"
                                                               id="id_contract_signed">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-group">
                                                    <div id="div_id_not_interested" class="form-check">
                                                        <label for="id_not_interested" class="form-check-label">Not Interested</label>
                                                        <input type="checkbox"
                                                               name="not_interested"
                                                               class="checkboxinput form-check-input"
                                                               id="id_not_interested">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_lead_status" class="form-group">
                                                    <label for="id_lead_status" class="">Status</label>
                                                    <div>
                                                        <select name="status" class="select form-control" id="id_lead_status">
                                                            <option value="" selected="">
                                                                ---------
                                                            </option>
                                                            <option value="1">
                                                                OPEN
                                                            </option>
                                                            <option value="2">
                                                                CLOSED
                                                            </option>
                                                            <option value="3">
                                                                EMAIL_NOT_FOUND
                                                            </option>
                                                            <option value="4">
                                                                SCHEDULED
                                                            </option>
                                                            <option value="5">
                                                                SENT
                                                            </option>
                                                            <option value="6" selected>
                                                                READY
                                                            </option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_contract_date" class="form-group">
                                                    <label for="id_contract_date" class="">Contract Date</label>
                                                    <div>
                                                        <input type="text"
                                                               name="contract_date"
                                                               class="dateinput form-control"
                                                               data-date-format="Y-m-d"
                                                               data-provider="flatpickr"
                                                               id="id_contract_date">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="mb-3">
                                                <div id="div_id_follow_ups" class="form-group">
                                                    <label for="id_follow_ups" class="">Follow ups</label>
                                                    <div>
                                                        <input type="number"
                                                               name="follow_ups"
                                                               value="0"
                                                               class="numberinput form-control"
                                                               id="id_follow_ups">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12">
                                            <div class="mb-3">
                                                <div id="div_id_notes" class="form-group">
                                                    <label for="id_notes" class="">Notes</label>
                                                    <div>
                                                        <textarea name="notes" cols="40" rows="10" class="textarea form-control" id="id_notes">
                                                    </textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end card body -->
                            </div>
                            <!-- end card -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light w-sm btn-cancel">Cancel</button>
                            <button type="submit" class="btn btn-primary btn-create-lead">Create</button>
                            <button type="button" class="btn btn-primary btn-load d-none">
                                <span class="d-flex align-items-center">
                                    <span class="flex-grow-1 me-2">Loading...</span>
                                    <span class="spinner-border flex-shrink-0" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <!-- container-fluid -->
        <!-- Modal FORM for Update Job Post -->
        <div id="jobPost"
            class="modal fade"
            tabindex="-1"
            aria-labelledby="jobPostLabel"
            aria-hidden="true"
            style="display: none;">
                <div class="modal-dialog modal-md modal-dialog-centered">
                    <div class="modal-content">
                        <form action="" id="updateJobPostForm">
                            {% csrf_token %}
                            <div class="modal-header">
                                <h5 class="modal-title" id="jobPostLabel">Job Post</h5>
                            </div>
                            <div class="modal-body">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_title" class="form-group">
                                            <label for="id_title" class=" requiredField">
                                                Title<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <input type="text"
                                                        name="title"
                                                        maxlength="200"
                                                        class="textinput textInput form-control"
                                                        id="id_title"
                                                        value="{{job_post.title}}"
                                                        required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button type="submit" class="btn btn-primary btn-update-jobpost">
                                        Update
                                    </button>
                                    <button type="button" class="btn btn-primary btn-load d-none">
                                        <span class="d-flex align-items-center">
                                            <span class="flex-grow-1 me-2">
                                                Loading...
                                            </span>
                                            <span class="spinner-border flex-shrink-0" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
        <!-- Modal FORM for Create New Person -->
        <div id="personModal"
             class="modal fade"
             tabindex="-1"
             aria-labelledby="personLabel"
             aria-hidden="true"
             style="display: none;">
            <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content">
                    <form action="" id="personForm">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="personLabel">
                                Person
                            </h5>
                            <div class="flex-shrink-0">
                                <button type="button" class="btn btn-primary btn-load-person">
                                    <span class="d-flex align-items-center">
                                        <span class="flex-grow-1 me-2">
                                            Loading DataBase...
                                        </span>
                                        <span class="spinner-border spinner-border-sm flex-shrink-0" role="status">
                                            <span class="visually-hidden">Loading DataBase...</span>
                                        </span>
                                    </span>
                                </button>
                                <button type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close">
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <input type="hidden" name="company" id="id_person_company" />
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_first_name" class="form-group">
                                            <label for="id_first_name" class="">
                                                First name
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="first_name"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_first_name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_last_name" class="form-group">
                                            <label for="id_last_name" class="">
                                                Last name
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="last_name"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_last_name">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_designation" class="form-group">
                                            <label for="id_designation" class="">
                                                Designation
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="designation"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_designation">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_linkedin" class="form-group">
                                            <label for="id_linkedin" class="">
                                                Linkedin
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="linkedin"
                                                       maxlength="1000"
                                                       class="textinput textInput form-control"
                                                       id="id_linkedin">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div id="div_id_email" class="form-group">
                                            <label for="id_email" class="">
                                                Email
                                            </label>
                                            <div>
                                                <input type="email"
                                                       name="email"
                                                       maxlength="254"
                                                       class="emailinput form-control"
                                                       id="id_email">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_email2" class="form-group">
                                            <label for="id_email2" class="">
                                                Email2
                                            </label>
                                            <div>
                                                <input type="email"
                                                       name="email2"
                                                       maxlength="254"
                                                       class="emailinput form-control"
                                                       id="id_email2">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_email3" class="form-group">
                                            <label for="id_email3" class="">
                                                Email3
                                            </label>
                                            <div>
                                                <input type="email"
                                                       name="email3"
                                                       maxlength="254"
                                                       class="emailinput form-control"
                                                       id="id_email3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_city" class="form-group">
                                            <label for="id_city" class="">
                                                City
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="city"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_city">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_state" class="form-group">
                                            <label for="id_state" class="">
                                                State
                                            </label>
                                            <div>
                                                <input type="text"
                                                       name="state"
                                                       maxlength="200"
                                                       class="textinput textInput form-control"
                                                       id="id_state">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_country" class="form-group">
                                            <label for="id_country" class=" requiredField">
                                                Country<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <select name="country"
                                                        class="select form-control"
                                                        id="id_person_country"
                                                        required>
                                                    <option value="" selected="">
                                                        ---------
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <div id="div_id_person_status" class="form-group">
                                            <label for="id_person_status" class=" requiredField">
                                                Status<span class="asteriskField">*</span>
                                            </label>
                                            <div>
                                                <select name="status"
                                                        class="select form-control"
                                                        id="id_person_status"
                                                        required>
                                                    <option value="1" selected>
                                                        New
                                                    </option>
                                                    <option value="2">
                                                        Email Not Found
                                                    </option>
                                                    <option value="3">
                                                        Contacted
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-light close-btn" data-bs-dismiss="modal">
                                Close
                            </button>
                            <button type="submit" class="btn btn-primary btn-create-person">
                                Create
                            </button>
                            <button type="button" class="btn btn-primary btn-load d-none">
                                <span class="d-flex align-items-center">
                                    <span class="flex-grow-1 me-2">
                                        Loading...
                                    </span>
                                    <span class="spinner-border flex-shrink-0" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!-- /.modal -->
    </div>
    <!-- End Page-content -->
    {% block footer %}
        {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
<!-- end main content-->
{% endblock content %}
{% block extra_content %}
{% endblock extra_content %}
{% block extra_js %}
<script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
<script>

window.onbeforeunload = function() {
    preSourceValue = $('#id_source').val();
    preJobPostValue = $('#id_job_post').val();
    preCompanyValue = $('#id_company').val();
    preSalesTaskValue = $('#id_sales_task').val();
    preSalesTemplateValue = $('#id_sales_template').val();
    preOutboundEmailValue = $('#id_outbound_email').val();
    localStorage.setItem("source", preSourceValue);
    localStorage.setItem("job_post",preJobPostValue);
    localStorage.setItem("company", preCompanyValue);
    localStorage.setItem("sales_task", preSalesTaskValue);
    localStorage.setItem("sales_template", preSalesTemplateValue);
    localStorage.setItem("outbound_email", preOutboundEmailValue);
}

$(document).ready(function(){

    const leadSourceChoices = new Choices(document.querySelector('#id_source'), {searchResultLimit: 50})
    const leadStatusChoices = new Choices(document.querySelector('#id_lead_status'),{shouldSort: false})
    const SalesTemplateChoices = new Choices(document.querySelector('#id_sales_template'), {searchResultLimit: 50})
    const outboundEmailChoices = new Choices(document.querySelector('#id_outbound_email'), {searchResultLimit: 50})
    const companyChoices = new Choices(document.querySelector('#id_company'), {searchResultLimit: 50})
    const jobPostChoices = new Choices(document.querySelector('#id_job_post'), {searchResultLimit: 50})
    const personChoices = new Choices(document.querySelector('#id_person'), {searchResultLimit: 50})
    const personCountryChoices = new Choices(document.querySelector('#id_person_country'), {searchResultLimit: 50, shouldSort: false})
    const LeadCompanyelement = document.getElementById('id_company');
    const LeadJobpostelement = document.getElementById('id_job_post');
    const outboundemailelement = document.getElementById('id_outbound_email');
    const salestaskelement = document.getElementById('id_sales_task');

    var leadProgress=0;

    $.ajax({
        type: "GET",
        url: '/api/salestemplate/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.name !== undefined && row.name !== null && row.name !== '' ? row.name : 'No Name'}))
            SalesTemplateChoices.clearChoices();
            newChoices.unshift({'value': '', 'label': '---------'})
            newChoices[1].selected = true;
            SalesTemplateChoices.setChoices(newChoices);
        },
        complete: function(){
            leadProgress +=1;
            if(leadProgress==2){
                $('.btn-load-lead').addClass('d-none');
            }
            var sales_template = localStorage.getItem("sales_template");
            if (sales_template == null || sales_template == ''){
                return
            }
            else{
                try{
                    sales_templateValue = parseInt(sales_template);
                    $.ajax({
                        type: "GET",
                        url: `/api/salestemplate/?action=dropdown&search=${sales_templateValue}`,
                        success: function(response){
                            value = response.results[0]
                        },
                        complete: function(){
                            SalesTemplateChoices.setChoices([{ value: value.id, label: value.name }])
                            SalesTemplateChoices.setChoiceByValue(value.id);
                        }
                    })
                } catch (err) {
                console.error(err);
                }
            }
        }
    })

    $.ajax({
        type: "GET",
        url: '/api/outboundemail/?action=dropdown',
        success: function(response){
            newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
            outboundEmailChoices.clearChoices()
            newChoices.unshift({'value': '', 'label': '---------'})
            newChoices[1].selected = true;
            outboundEmailChoices.setChoices(newChoices);
        },
        complete: function(){
            leadProgress +=1;
            if(leadProgress==2){
                $('.btn-load-lead').addClass('d-none');
            }
            var outbound_email = localStorage.getItem("outbound_email");
            if (outbound_email == null || outbound_email == ''){
                return
            }
            else{
                try{
                    outbound_emailValue = parseInt(outbound_email);
                    $.ajax({
                        type: "GET",
                        url: `/api/outboundemail/?action=dropdown&search=${outbound_emailValue}`,
                        success: function(response){
                            value = response.results[0]
                        },
                        complete: function(){
                            outboundEmailChoices.setChoices([{ value: value.id, label: value.email }])
                            outboundEmailChoices.setChoiceByValue(value.id);
                        }
                    })
                } catch (err) {
                console.error(err);
                }
            }
        }
    })

    var ajax_outboundEmail = null;
    outboundemailelement.addEventListener(
        'search',
        function(event) {
        // do something creative here...
        if(ajax_outboundEmail != null){
            ajax_outboundEmail.abort();
            ajax_outboundEmail = null
        }
        let input = event.detail.value
        outboundEmailChoices.clearChoices();
        ajax_outboundEmail = $.ajax({
                type: "GET",
                url: `/api/outboundemail/?action=dropdown&search=${input}`,
                success: function(response){
                    newChoices = response.results.map((row) => ({'value': row.id, 'label': row.email !== undefined && row.email !== null && row.email !== '' ? row.email : 'No Email'}))
                    outboundEmailChoices.clearChoices()
                    newChoices.unshift({'value': '', 'label': '---------'})
                    outboundEmailChoices.setChoices(newChoices);
                },
            })
        },
        false,
    );

    $('#div_id_job_post > div').addClass('d-flex').append('<button class="btn btn-success flex-shrink-0 ms-1 jobpostModal" type="button" style="height:38px" data-bs-toggle="modal" data-bs-target="#jobPost"><i class="ri-pencil-fill fs-16"></i></button>')
    $('#div_id_job_post > div > div').addClass('flex-grow-1')

    $('#div_id_person > div').addClass('d-flex').append('<button class="btn btn-success flex-shrink-0 ms-1 personModal" type="button" style="height:38px" data-bs-toggle="modal" data-bs-target="#personModal">+</button>')    
    $('#div_id_person > div > div').addClass('flex-grow-1')


    // Create Person Button Ajax
    $('button.personModal').click(function(){
        $.ajax({
            type: "GET",
            url: '/leads/countrieslist/',
            data: {},
            success: function(response){
                newChoices = response.data.map((row) => ({'value': row.Code, 'label': row.Name ?? ''}))
                personCountryChoices.clearChoices()
                newChoices.unshift({'value': '', 'label': '---------'})
                personCountryChoices.setChoices(newChoices);
            },
            complete: function(){
                $('.btn-load-person').addClass('d-none');
            }
        })
    })

    // Create Lead
    $('#leadForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('.btn-load').removeClass('d-none');
        $('.btn-create-lead').addClass('d-none');
        var form = $(this);
        var resume_sent_checkbox = document.getElementById('id_resume_sent');
        var interested_checkbox = document.getElementById('id_interested');
        var response_checkbox = document.getElementById('id_response');
        var contract_signed_checkbox = document.getElementById('id_contract_signed');
        var not_interested_checkbox = document.getElementById('id_not_interested');
        var resume_sent_isChecked = resume_sent_checkbox.checked;
        var interested_isChecked = interested_checkbox.checked;
        var response_isChecked = response_checkbox.checked;
        var contract_signed_isChecked = contract_signed_checkbox.checked;
        var not_interested_isChecked = not_interested_checkbox.checked;
        if (resume_sent_checkbox){
            form.find('input[name="resume_sent"]').val(1);
        }
        else{
            form.find('input[name="resume_sent"]').val(0);
        }
        if (interested_isChecked){
            form.find('input[name="interested"]').val(1);
        }
        else{
            form.find('input[name="interested"]').val(0);
        }
        if (response_isChecked){
            form.find('input[name="response"]').val(1);
        }
        else{
            form.find('input[name="response"]').val(0);
        }
        if (contract_signed_isChecked){
            form.find('input[name="contract_signed"]').val(1);
        }
        else{
            form.find('input[name="contract_signed"]').val(0);
        }
        if (not_interested_isChecked){
            form.find('input[name="not_interested"]').val(1);
        }
        else{
            form.find('input[name="not_interested"]').val(0);
        }
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/lead/`,
            data: form.serialize(), // serializes the form's elements.
            success: function(response)
            {
                    // Show the success message
                Toastify({
                    text: "The Leads has been added successfully",
                  }).showToast();
                  $('.btn-load').addClass('d-none');
                  $('.btn-create-lead').removeClass('d-none');
                localStorage.clear();
                $.ajax({
                    type: "PATCH",
                    headers: { "X-CSRFToken": '{{csrf_token}}' },
                    url: `/api/leadtasks/{{leadtask_id}}/`,
                    data: {'completed': true},
                    success: (response) => {
                        window.location = `{% url 'leads:lead_list' %}`;
                    },
                    error: (xhr, status, error) => {
                        // Handle Ajax Error for API
                        var err = eval("(" + xhr.responseText + ")");
                        console.log(err)
                        Toastify({
                            text: err?.status || 'Oops something went wrong with completing the Lead Task',
                            className: "bg-danger"
                        }).showToast();
                    },
                });
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `${field}: ${err[field]}`,
                            className: 'bg-danger',
                            style: {
                              'text-transform': "capitalize",
                            },
                        }).showToast();
                    })

                } else {
                    Toastify({
                      text: "Oops something went wrong.",
                      className: 'bg-danger'
                    }).showToast();
                }
                $('.btn-load').addClass('d-none');
                $('.btn-create-lead').removeClass('d-none');
            }
        });
    })


    // Reset the person form on close the modal
    const personFormModalEl = document.getElementById('personModal')
    personFormModalEl.addEventListener('hidden.bs.modal', event => {
        $('#personForm').trigger('reset')
        $('.btn-load').addClass('d-none');
        $('.btn-create-person').removeClass('d-none');
    })

    // Update Job Post
    $('#updateJobPostForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('.btn-load').removeClass('d-none');
        $('.btn-update-jobpost').addClass('d-none');
        var form = $(this);
        $.ajax({
            type: "PUT",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/jobpost/{{job_post.id}}/`,
            data: form.serialize(),
            success: function(response)
            {
                Toastify({
                    text: "Job Post has been updated successfully",
                }).showToast();
                $('.btn-load').addClass('d-none');
                $('.btn-update-jobpost').removeClass('d-none');
                form.trigger("reset");
                $('.close-btn').trigger('click')
                window.location.reload();
            },
            error: (xhr, status, error) => {
                var err = eval("(" + xhr.responseText + ")");
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `Error: ${err[field]}`,
                            className: 'bg-danger',
                        }).showToast();
                    })
                    
                } else {
                    Toastify({
                        text: "Oops something went wrong.",
                        className: 'bg-danger'
                    }).showToast();
                }
                $('.btn-load').addClass('d-none');
                $('.btn-update-jobpost').removeClass('d-none');
            }
        });
    })

    // Create New Person
    $('#personForm').submit(function(e){
        e.preventDefault(); // avoid to execute the actual submit of the form.
        $('#id_person_company').val(companyChoices.getValue('id'))
        $('#id_company1').val(companyChoices.getValue('id'))
        $('.btn-load').removeClass('d-none');
        $('.btn-create-person').addClass('d-none');
        var form = $(e.target);
        let companyValue = companyChoices.getValue();
        let s_companyValue = companyValue['label'].search("Blocked Company");
        if(s_companyValue != -1){
            Toastify({
                text: "Error: Selected Company is Blocked!",
                className: 'bg-danger'
              }).showToast();
        }
        else{
        $.ajax({
            type: "POST",
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: `/api/person/`,
            data: form.serialize(), // serializes the form's elements.
            success: (response) => {
                // show response.
                personChoices.setChoices(
                    [
                        {value: response.id, label: response.first_name, selected: true}
                    ]
                )
                form.trigger("reset");
                $('.close-btn').trigger('click')
                Toastify({
                    text: "The Person has been added successfully",
                }).showToast();
            },
            complete: function(){
                $('.btn-load').addClass('d-none');
                $('.btn-create-person').removeClass('d-none');
            },
            error: (xhr, status, error) => {
                // Handle Ajax Error for API
                var err = eval("(" + xhr.responseText + ")");
                console.error(err)
                if(Object.keys(err).length){
                    Object.keys(err).forEach((field) => {
                        Toastify({
                            text: `${field}: ${err[field]}`,
                            className: 'bg-danger',
                            style: {
                              'text-transform': "capitalize",
                            },
                        }).showToast();
                    })

                } else {
                    Toastify({
                      text: "Oops something went wrong.",
                      className: 'bg-danger'
                    }).showToast();
                }


                $('.btn-load').addClass('d-none');
                $('.btn-create-person').removeClass('d-none');
            }
        });
    }
    })
    $(".btn-cancel").click(function(){
        localStorage.clear();
        window.location = `{% url 'leads:assignedleadtasks_list' %}`;
    })

})
    </script>
{% endblock extra_js %}
